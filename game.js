dojo.declare("classes.game.Timer",null,{handlers:[],scheduledHandlers:[],ticksTotal:0,timestampStart:null,totalUpdateTime:null,addEvent:function(a,b){this.handlers.push({handler:a,frequency:b,phase:0})},update:function(){for(var a=0;a<this.handlers.length;a++){var b=this.handlers[a];b.phase--;0>=b.phase&&(b.phase=b.frequency,b.handler())}},scheduleEvent:function(a){this.scheduledHandlers.push(a)},updateScheduledEvents:function(){for(var a in this.scheduledHandlers)this.scheduledHandlers[a]();this.scheduledHandlers=
[]},beforeUpdate:function(){this.timestampStart=(new Date).getTime()},afterUpdate:function(){this.ticksTotal++;var a=(new Date).getTime()-this.timestampStart;this.totalUpdateTime+=a;this.currentTime=a;this.averageTime=Math.round(this.totalUpdateTime/this.ticksTotal)}});dojo.declare("mixin.IDataStorageAware",null,{constructor:function(){dojo.subscribe("server/save",dojo.hitch(this,this.save));dojo.subscribe("server/load",dojo.hitch(this,this.load))}});
dojo.declare("classes.game.Telemetry",[mixin.IDataStorageAware],{guid:null,game:null,buildRevision:null,version:null,errorCount:0,constructor:function(a){this.guid=this.generateGuid();this.game=a},generateGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){return("x"==a?16*Math.random()|0:4*Math.random()|8).toString(16)})},save:function(a){a.telemetry={guid:this.guid}},load:function(a){a.telemetry&&(this.guid=a.telemetry.guid||this.generateGuid());var b=this;window.newrelic&&
!this.game.opts.disableTelemetry&&(window.newrelic.addRelease("KG",this.version+".r"+this.buildRevision),window.newrelic.setCustomAttribute("buildRevision",this.version+".r"+this.buildRevision),window.newrelic.setCustomAttribute("guid",this.guid),this.game.server.userProfile&&window.newrelic.setCustomAttribute("uid",this.game.server.userProfile.uid),window.newrelic.setErrorHandler(function(c){b.game.achievements.unlockBadge("ghostInTheMachine");if(100<=b.errorCount||0<=c.stack.lastIndexOf("mikiso1024"))return!0;
b.errorCount++;return!1}))},logEvent:function(a,b){b=b||{};window.newrelic&&!this.game.opts.disableTelemetry&&window.newrelic.addPageAction(a,b)},logRouteChange:function(a){if(window.newrelic&&!this.game.opts.disableTelemetry){var b=window.newrelic.interaction();window.newrelic.setCurrentRouteName(a);b.save();this.logEvent("routeChange",{name:a})}}});
dojo.declare("classes.game.Server",null,{showMotd:!0,motdTitle:null,motdContent:null,game:null,motdContentPrevious:null,motdFreshMessage:!1,userProfile:null,chiral:null,lastBackup:null,saveData:null,constructor:function(a){this.game=a},setUserProfile:function(a){this.userProfile=a;if((new RegExp(/^\d+$/)).test(a.email.slice(0,a.email.indexOf("@")))&&"qq.com"===a.email.slice(a.email.indexOf("@")+1,a.email.length)){var b=a.email.slice(0,a.email.length-7);$.ajax({cache:!0,type:"GET",dataType:"JSON",
url:"https://tenapi.cn/qqname/",data:{qq:b}}).done(function(c){a.qqName=c?c.name:a.email})}else a.qqName=a.email},getServerUrl:function(){return"https://kittensgame.com"},refresh:function(){var a=this;console.log("Loading server settings...");$.ajax({cache:!1,url:"server.json",dataType:"json",success:function(b){a.showMotd=b.showMotd;a.motdTitle=b.motdTitle;a.motdContent=b.motdContent}}).done(function(){a.motdContentPrevious!=a.motdContent&&(a.motdContentPrevious=a.motdContent,a.motdFreshMessage=
!0)}).fail(function(b){console.log("Unable to parse server.json configuration:",b)});this.userProfile||this.syncUserProfile()},_xhr:function(a,b,c,d){return $.ajax({cache:!1,type:b||"GET",dataType:"JSON",url:this.getServerUrl()+a,xhrFields:{withCredentials:!0},data:c}).done(function(e){d(e)})},syncUserProfile:function(){var a=this;this._xhr("/user/","GET",{},function(b){b&&b.id&&a.setUserProfile(b)})},syncSaveData:function(){var a=this;return this._xhr("/kgnet/save/","GET",{},function(b){a.saveData=
b})},register:function(){var a=document.getElementById("registerError");if("\u53d1\u9001\u8bf7\u6c42\u4e2d\uff0c\u8bf7\u7a0d\u5019"!=a.innerHTML){var b=document.getElementById("loginPassword"),c=document.getElementById("registerEmail"),d=document.getElementById("confirmPassword");if(""==b.value||""==c.value||""==d.value)return a.innerHTML="\u8bf7\u586b\u5199\u5b8c\u6574!";if(c.value&&-1==c.value.indexOf("@"))return a.innerHTML="\u90ae\u4ef6\u5730\u5740\u683c\u5f0f\u9519\u8bef!";if(d.value!=b.value)return a.innerHTML=
"\u4e24\u6b21\u5bc6\u7801\u4e0d\u4e00\u6837!";5>=b.value.length?a.innerHTML="\u5bc6\u7801\u957f\u5ea6\u81f3\u5c116\u4f4d!":(b={email:c.value,password:b.value},a.innerHTML="\u53d1\u9001\u8bf7\u6c42\u4e2d\uff0c\u8bf7\u7a0d\u5019",$.post("https://kittensgame.com/user/register/",b).done(function(e){a.innerHTML=e.error?$I(e.error):"<span style='color:#14CD61;'>\u6ce8\u518c\u6210\u529f</span>"}).fail(()=>{a.innerHTML="\u7f51\u7edc\u53ef\u80fd\u51fa\u4e86\u95ee\u9898"}))}},pushSave:function(){var a=this,
b=this.game;b.lastBackup=(new Date).getTime();var c=this.game.save();this._xhr("/kgnet/save/upload/","POST",{guid:this.game.telemetry.guid,saveData:this.game.compressLZData(JSON.stringify(c),!0),metadata:{calendar:{year:b.calendar.year,day:b.calendar.day}}},function(d){console.log("save successful?");a.saveData=d;a.game.msg($I("save.export.msg"))})},pushSaveMetadata:function(a,b){return this._xhr("/kgnet/save/update/","POST",{guid:a,metadata:b},function(c){self.saveData=c})},loadSave:function(a){var b=
this;this._xhr("/kgnet/save/"+a+"/download/","GET",{},function(c){c.data||console.error("unable to load game data",c);LCstorage["com.nuclearunicorn.kittengame.savedata"]=c.data;console.log("load successful?");b.game.load();b.game.msg($I("save.import.msg"))})},save:function(a){a.server={motdContent:this.motdContent}},sendCommand:function(a){var b=this;this._xhr("/kgnet/chiral/game/command/","POST",{command:a},function(c){c.clientState&&b.setChiral(c)})},setChiral:function(a){this.chiral=JSON.stringify(a,
null,2)}});dojo.declare("classes.game.UndoChange",null,{_static:{DEFAULT_TTL:20},ttl:0,events:null,constructor:function(){this.events=[]},addEvent:function(a,b){this.events.push({managerId:a,data:b})}});
dojo.declare("com.nuclearunicorn.game.EffectsManager",null,{game:null,constructor:function(a){this.game=a},effectMeta:function(a){for(var b=this.game,c=0;c<b.resPool.resources.length;c++){var d=b.resPool.resources[c];if(0==a.indexOf(d.name)){var e=d.name,f=d.title||e;f=f.charAt(0).toUpperCase()+f.substring(1,f.length);var g=a.substring(e.length,a.length);break}}switch(!0){case ""==g:return{title:f,resName:e,type:"perTick"};case "PerTick"==g:return{title:f,resName:e,type:"perTick"};case "PerTickRatio"==
g:return{title:$I("effectsMgr.type.resRatio",[f]),resName:e,type:"ratio"};case "Max"==g:return{title:$I("effectsMgr.type.resMax",[f]),resName:e};case "MaxChallenge"==g:return{title:$I("effectsMgr.type.resMax",[f]),resName:e};case "Ratio"==g:return{title:$I("effectsMgr.type.resRatio",[f]),resName:e,type:"ratio"};case "DemandRatio"==g:return{title:$I("effectsMgr.type.resDemandRatio",[f]),resName:e,type:"ratio"};case "PerTickBase"==g||"PerTickBaseSpace"==g:return{title:$I("effectsMgr.type.resProduction",
[f]),resName:e,type:"perTick"};case "PerTickCon"==g||"PerTickAutoprod"==g||"PerTickProd"==g||"PerTickSpace"==g||"PerTickAutoprodSpace"==g:return{title:$I("effectsMgr.type.resConversion",[f]),resName:e,type:"perTick"};case "CraftRatio"==g:return{title:$I("effectsMgr.type.resCraftRatio",[f]),resName:e,type:"ratio"};case "GlobalCraftRatio"==g:return{title:$I("effectsMgr.type.resGlobalCraftRatio",[f]),resName:e,type:"ratio"};default:return 0}},statics:{effectMeta:{catnipJobRatio:{title:$I("effectsMgr.statics.catnipJobRatio.title"),
resName:"catnip",type:"ratio"},catnipDemandWorkerRatioGlobal:{title:$I("effectsMgr.statics.catnipDemandWorkerRatioGlobal.title"),resName:"catnip",type:"ratio"},woodJobRatio:{title:$I("effectsMgr.statics.woodJobRatio.title"),resName:"wood",type:"ratio"},manpowerJobRatio:{title:$I("effectsMgr.statics.manpowerJobRatio.title"),resName:"manpower",type:"ratio"},coalRatioGlobal:{title:$I("effectsMgr.statics.coalRatioGlobal.title"),resName:"coal",type:"ratio",calculation:"nonProportional"},coalRatioGlobalReduction:{title:$I("effectsMgr.statics.coalRatioGlobalReduction.title"),
resName:"coal",type:"ratio"},oilReductionRatio:{title:$I("effectsMgr.statics.oilReductionRatio.title"),type:"ratio"},maxKittens:{title:$I("effectsMgr.statics.maxKittens.title")},maxKittensRatio:{title:$I("effectsMgr.statics.maxKittensRatio.title"),type:"ratio"},simScalingRatio:{title:$I("effectsMgr.statics.simScalingRatio.title"),type:"ratio"},antimatterProduction:{title:$I("effectsMgr.statics.antimatterProduction.title"),type:"perYear"},temporalFluxProduction:{title:$I("effectsMgr.statics.temporalFluxProduction.title"),
type:"perYear"},temporalFluxProductionChronosphere:{title:$I("effectsMgr.statics.temporalFluxProductionChronosphere.title"),type:"perYear"},observatoryRatio:{title:$I("effectsMgr.statics.observatoryRatio.title"),type:"ratio"},magnetoBoostRatio:{title:$I("effectsMgr.statics.magnetoBoostRatio.title"),resName:"oil",type:"ratio"},skillXP:{title:$I("effectsMgr.statics.skillXP.title"),type:"perTick"},refineRatio:{title:$I("effectsMgr.statics.refineRatio.title"),type:"ratio"},craftRatio:{title:$I("effectsMgr.statics.craftRatio.title"),
type:"ratio"},happiness:{title:$I("effectsMgr.statics.happiness.title")},unhappinessRatio:{title:$I("effectsMgr.statics.unhappinessRatio.title"),type:"ratio"},tradeRatio:{title:$I("effectsMgr.statics.tradeRatio.title"),type:"ratio"},standingRatio:{title:$I("effectsMgr.statics.standingRatio.title"),type:"ratio"},resStasisRatio:{title:$I("effectsMgr.statics.resStasisRatio.title"),type:"ratio"},beaconRelicsPerDay:{title:$I("effectsMgr.statics.beaconRelicsPerDay.title"),type:"perDay"},relicPerDay:{title:$I("effectsMgr.statics.relicPerDay.title"),
type:"perDay"},routeSpeed:{title:$I("effectsMgr.statics.routeSpeed.title"),type:"fixed"},festivalRatio:{title:$I("effectsMgr.statics.festivalRatio.title"),type:"ratio"},festivalArrivalRatio:{title:$I("effectsMgr.statics.festivalArrivalRatio.title"),type:"ratio"},energyProduction:{title:$I("effectsMgr.statics.energyProduction.title"),type:"energy"},energyConsumption:{title:$I("effectsMgr.statics.energyConsumption.title"),type:"energy",calculation:"nonProportional"},energyProductionRatio:{title:$I("effectsMgr.statics.energyProductionRatio.title"),
type:"ratio"},energyConsumptionRatio:{title:$I("effectsMgr.statics.energyConsumptionRatio.title"),type:"ratio"},energyConsumptionIncrease:{title:$I("effectsMgr.statics.energyConsumptionIncrease.title"),type:"ratio"},productionRatio:{title:$I("effectsMgr.statics.productionRatio.title"),type:"ratio"},magnetoRatio:{title:$I("effectsMgr.statics.magnetoRatio.title"),type:"ratio"},spaceRatio:{title:$I("effectsMgr.statics.spaceRatio.title"),type:"ratio"},prodTransferBonus:{title:$I("effectsMgr.statics.prodTransferBonus.title"),
type:"ratio"},starEventChance:{title:$I("effectsMgr.statics.starEventChance.title"),type:"ratio"},starAutoSuccessChance:{title:$I("effectsMgr.statics.starAutoSuccessChance.title"),type:"ratio"},lumberMillRatio:{title:$I("effectsMgr.statics.lumberMillRatio.title"),type:"ratio"},barnRatio:{title:$I("effectsMgr.statics.barnRatio.title"),type:"ratio"},warehouseRatio:{title:$I("effectsMgr.statics.warehouseRatio.title"),type:"ratio"},acceleratorRatio:{title:$I("effectsMgr.statics.acceleratorRatio.title"),
type:"ratio"},harborRatio:{title:$I("effectsMgr.statics.harborRatio.title"),type:"ratio"},harborCoalRatio:{title:$I("effectsMgr.statics.harborCoalRatio.title"),type:"ratio"},catnipMaxRatio:{title:$I("effectsMgr.statics.catnipMaxRatio.title"),type:"ratio",resName:"catnip"},hunterRatio:{title:$I("effectsMgr.statics.hunterRatio.title"),type:"ratio"},solarFarmRatio:{title:$I("effectsMgr.statics.solarFarmRatio.title"),type:"ratio"},shipLimit:{title:$I("effectsMgr.statics.shipLimit.title"),type:"ratio"},
hutPriceRatio:{title:$I("effectsMgr.statics.hutPriceRatio.title"),type:"ratio"},coalSuperRatio:{title:$I("effectsMgr.statics.coalSuperRatio.title"),type:"ratio"},smelterRatio:{title:$I("effectsMgr.statics.smelterRatio.title"),type:"ratio"},calcinerRatio:{title:$I("effectsMgr.statics.calcinerRatio.title"),type:"ratio"},calcinerSteelRatio:{title:$I("effectsMgr.statics.calcinerSteelRatio.title"),type:"ratio"},calcinerSteelCraftRatio:{title:$I("effectsMgr.statics.calcinerSteelCraftRatio.title"),type:"ratio"},
calcinerSteelReactorBonus:{title:$I("effectsMgr.statics.calcinerSteelReactorBonus.title"),type:"ratio"},libraryRatio:{title:$I("effectsMgr.statics.libraryRatio.title"),type:"ratio"},hydroPlantRatio:{title:$I("effectsMgr.statics.hydroPlantRatio.title"),type:"ratio"},spaceScienceRatio:{title:$I("effectsMgr.statics.spaceScienceRatio.title"),type:"ratio"},oilWellRatio:{title:$I("effectsMgr.statics.oilWellRatio.title"),type:"ratio"},unicornsGlobalRatio:{title:$I("effectsMgr.statics.unicornsGlobalRatio.title"),
type:"ratio"},biofuelRatio:{title:$I("effectsMgr.statics.biofuelRatio.title"),type:"ratio"},cadBlueprintCraftRatio:{title:$I("effectsMgr.statics.cadBlueprintCraftRatio.title"),type:"ratio"},skillMultiplier:{title:$I("effectsMgr.statics.skillMultiplier.title"),type:"ratio"},masterSkillMultiplier:{title:$I("effectsMgr.statics.masterSkillMultiplier.title"),type:"ratio"},uraniumRatio:{title:$I("effectsMgr.statics.uraniumRatio.title"),type:"ratio"},reactorEnergyRatio:{title:$I("effectsMgr.statics.reactorEnergyRatio.title"),
type:"ratio"},reactorThoriumPerTick:{title:$I("effectsMgr.statics.reactorThoriumPerTick.title"),type:"perTick"},starchartGlobalRatio:{title:$I("effectsMgr.statics.starchartGlobalRatio.title"),type:"ratio"},satnavRatio:{title:$I("effectsMgr.statics.satnavRatio.title"),type:"ratio"},broadcastTowerRatio:{title:$I("effectsMgr.statics.broadcastTowerRatio.title"),type:"ratio"},cultureMaxRatio:{title:$I("effectsMgr.statics.cultureMaxRatio.title"),type:"ratio"},lunarOutpostRatio:{title:$I("effectsMgr.statics.lunarOutpostRatio.title"),
type:"ratio"},crackerRatio:{title:$I("effectsMgr.statics.crackerRatio.title"),type:"ratio"},factoryRefineRatio:{title:$I("effectsMgr.statics.factoryRefineRatio.title"),type:"ratio"},timeRatio:{title:$I("effectsMgr.statics.timeRatio.title"),type:"ratio"},temporalParadoxVoid:{title:$I("effectsMgr.statics.temporalParadoxVoid.title"),type:"perDay"},temporalParadoxDay:{title:$I("effectsMgr.statics.temporalParadoxDay.title"),type:"fixed"},temporalParadoxDayBonus:{title:$I("effectsMgr.statics.temporalParadoxDayBonus.title"),
type:"fixed"},unicornsRatioReligion:{title:$I("effectsMgr.statics.unicornsRatioReligion.title"),type:"ratio"},riftChance:{title:$I("effectsMgr.statics.riftChance.title"),type:"ratio"},ivoryMeteorChance:{title:$I("effectsMgr.statics.ivoryMeteorChance.title"),type:"ratio"},ivoryMeteorRatio:{title:$I("effectsMgr.statics.ivoryMeteorRatio.title"),type:"ratio"},goldMaxRatio:{title:$I("effectsMgr.statics.goldMaxRatio.title"),type:"ratio"},alicornChance:{title:$I("effectsMgr.statics.alicornChance.title"),
type:"ratio"},tcRefineRatio:{title:$I("effectsMgr.statics.tcRefineRatio.title"),type:"ratio"},corruptionRatio:{title:$I("effectsMgr.statics.corruptionRatio.title"),type:"ratio"},cultureMaxRatioBonus:{title:$I("effectsMgr.statics.cultureMaxRatioBonus.title"),type:"ratio"},faithRatioReligion:{title:$I("effectsMgr.statics.faithRatioReligion.title"),type:"ratio"},solarRevolutionLimit:{title:$I("effectsMgr.statics.solarRevolutionLimit.title"),type:"ratio"},solarRevolutionRatio:{title:$I("effectsMgr.statics.solarRevolutionRatio.title"),
type:"ratio"},faithSolarRevolutionBoost:{title:$I("effectsMgr.statics.faithSolarRevolutionBoost.title"),type:"ratio"},relicRefineRatio:{title:$I("effectsMgr.statics.relicRefineRatio.title"),type:"ratio"},blsLimit:{title:$I("effectsMgr.statics.blsLimit.title"),type:"integerRatio"},globalResourceRatio:{title:$I("effectsMgr.statics.globalResourceRatio.title"),type:"ratio"},timeImpedance:{title:$I("effectsMgr.statics.timeImpedance.title"),type:"fixed"},shatterTCGain:{title:$I("effectsMgr.statics.shatterTCGain.title"),
type:"ratio"},rrRatio:{title:$I("effectsMgr.statics.rrRatio.title"),type:"ratio"},priceRatio:{title:$I("effectsMgr.statics.priceRatio.title"),type:"ratio"},kittenGrowthRatio:{title:$I("effectsMgr.statics.kittenGrowthRatio.title"),type:"ratio"},t1CraftRatio:{title:$I("effectsMgr.statics.t1CraftRatio.title"),type:"fixed"},t2CraftRatio:{title:$I("effectsMgr.statics.t2CraftRatio.title"),type:"fixed"},t3CraftRatio:{title:$I("effectsMgr.statics.t3CraftRatio.title"),type:"fixed"},t4CraftRatio:{title:$I("effectsMgr.statics.t4CraftRatio.title"),
type:"fixed"},t5CraftRatio:{title:$I("effectsMgr.statics.t5CraftRatio.title"),type:"fixed"},queueCap:{title:$I("effectsMgr.statics.queueCap"),type:"fixed"},"spaceElevator-prodTransferBonus":{title:$I("effectsMgr.statics.spaceElevator-prodTransferBonus.title"),type:"ratio"},"sattelite-starchartPerTickBaseSpace":{title:$I("effectsMgr.statics.sattelite-starchartPerTickBaseSpace.title"),type:"ratio"},"sattelite-observatoryRatio":{title:$I("effectsMgr.statics.sattelite-observatoryRatio.title"),type:"ratio"},
"spaceStation-scienceRatio":{title:$I("effectsMgr.statics.spaceStation-scienceRatio.title"),type:"ratio"},"moonOutpost-unobtainiumPerTickSpace":{title:$I("effectsMgr.statics.moonOutpost-unobtainiumPerTickSpace.title"),type:"ratio"},"planetCracker-uraniumPerTickSpace":{title:$I("effectsMgr.statics.planetCracker-uraniumPerTickSpace.title"),type:"ratio"},"hydrofracturer-oilPerTickAutoprodSpace":{title:$I("effectsMgr.statics.hydrofracturer-oilPerTickAutoprodSpace.title"),type:"ratio"},"researchVessel-starchartPerTickBaseSpace":{title:$I("effectsMgr.statics.researchVessel-starchartPerTickBaseSpace.title"),
type:"ratio"},"sunlifter-energyProduction":{title:$I("effectsMgr.statics.sunlifter-energyProduction.title"),type:"ratio"},"cryostation-woodMax":{title:$I("effectsMgr.statics.cryostation-woodMax.title"),type:"ratio"},"cryostation-mineralsMax":{title:$I("effectsMgr.statics.cryostation-mineralsMax.title"),type:"ratio"},"cryostation-ironMax":{title:$I("effectsMgr.statics.cryostation-ironMax.title"),type:"ratio"},"cryostation-coalMax":{title:$I("effectsMgr.statics.cryostation-coalMax.title"),type:"ratio"},
"cryostation-uraniumMax":{title:$I("effectsMgr.statics.cryostation-uraniumMax.title"),type:"ratio"},"cryostation-titaniumMax":{title:$I("effectsMgr.statics.cryostation-titaniumMax.title"),type:"ratio"},"cryostation-oilMax":{title:$I("effectsMgr.statics.cryostation-oilMax.title"),type:"ratio"},"cryostation-unobtainiumMax":{title:$I("effectsMgr.statics.cryostation-unobtainiumMax.title"),type:"ratio"},"spaceBeacon-starchartPerTickBaseSpace":{title:$I("effectsMgr.statics.spaceBeacon-starchartPerTickBaseSpace.title"),
type:"ratio"},"hydroponics-catnipRatio":{title:$I("effectsMgr.statics.hydroponics-catnipRatio.title"),type:"ratio"},"hrHarvester-energyProduction":{title:$I("effectsMgr.statics.hrHarvester-energyProduction.title"),type:"ratio"},"entangler-gflopsConsumption":{title:$I("effectsMgr.statics.entangler-gflopsConsumption.title"),type:"ratio"},hrProgress:{title:$I("effectsMgr.statics.entangler-hrProgress.title"),type:"ratio",calculation:"nonProportional"},aiLevel:{title:$I("effectsMgr.statics.aiLevel.title"),
type:"fixed",calculation:"nonProportional"},gflopsConsumption:{title:$I("effectsMgr.statics.gflopsConsumption.title"),type:"perTick"},hashrate:{title:$I("effectsMgr.statics.hashrate.title"),type:"fixed",calculation:"nonProportional"},nextHashLevelAt:{title:$I("effectsMgr.statics.nextHashLevelAt.title"),type:"fixed",calculation:"nonProportional"},hashRateLevel:{title:$I("effectsMgr.statics.hashrateLevel.title"),type:"fixed",calculation:"nonProportional"},corruptionBoostRatio:{title:$I("effectsMgr.statics.corruptionBoostRatio.title"),
type:"ratio"},corruptionBoostRatioChallenge:{title:$I("effectsMgr.statics.corruptionBoostRatioChallenge.title"),type:"ratio"},blsCorruptionRatio:{title:$I("effectsMgr.statics.blsCorruptionRatio.title"),type:"ratio"},baseMetalMaxRatio:{title:$I("effectsMgr.statics.baseMetalMaxRatio.title"),type:"ratio"},scienceMaxCompendia:{title:$I("effectsMgr.statics.scienceMaxCompendia.title"),type:"fixed"},uplinkDCRatio:{title:$I("effectsMgr.statics.uplinkDCRatio.title"),type:"ratio"},uplinkLabRatio:{title:$I("effectsMgr.statics.uplinkLabRatio.title"),
type:"ratio"},dataCenterAIRatio:{title:$I("effectsMgr.statics.dataCenterAIRatio.title")},compendiaTTBoostRatio:{title:$I("effectsMgr.statics.compendiaTTBoostRatio.title"),type:"ratio"},blackLibraryBonus:{title:$I("effectsMgr.statics.blackLibraryBonus.title"),type:"ratio"},solarFarmSeasonRatio:{title:$I("effectsMgr.statics.solarFarmSeasonRatio.title"),type:"fixed"},tectonicBonus:{title:$I("effectsMgr.statics.tectonicBonus.title"),type:"ratio"},umbraBoostRatio:{title:$I("effectsMgr.statics.umbraBoostRatio.title"),
type:"ratio"},eludiumAutomationBonus:{title:$I("effectsMgr.statics.eludiumAutomationBonus.title"),type:"ratio"},heatMax:{title:$I("effectsMgr.statics.heatMax.title"),type:"fixed"},heatPerTick:{title:$I("effectsMgr.statics.heatPerTick.title"),type:"perTick"},heatMaxExpansion:{title:$I("effectsMgr.statics.heatMaxExpansion.title"),type:"fixed",calculation:"nonProportional"},voidResonance:{title:$I("effectsMgr.statics.voidResonance.title"),type:"ratio"},terraformingMaxKittensRatio:{title:$I("effectsMgr.statics.terraformingMaxKittens.title"),
type:"ratio",calculation:"nonProportional"},happinessKittenProductionRatio:{title:$I("effectsMgr.statics.happinessKittenProductionRatio.title"),type:"ratio"},cultureFromManuscripts:{title:$I("effectsMgr.statics.cultureFromManuscripts.title"),type:"ratio"},manuscriptParchmentCost:{title:$I("effectsMgr.statics.manuscriptCost.title",[$I("resources.parchment.title")]),type:"fixed"},manuscriptCultureCost:{title:$I("effectsMgr.statics.manuscriptCost.title",[$I("resources.culture.title")]),type:"fixed"},
rankLeaderBonusConversion:{title:$I("effectsMgr.statics.rankLeaderBonusConversion.title"),type:"ratio"},boostFromLeader:{title:$I("effectsMgr.statics.boostFromLeader.title"),type:"ratio"},goldCostReduction:{title:$I("effectsMgr.statics.goldCostReduction.title"),type:"ratio"},factoryCostReduction:{title:$I("effectsMgr.statics.factoryCostReduction.title"),type:"ratio"},logHouseCostReduction:{title:$I("effectsMgr.statics.logHouseCostReduction.title"),type:"ratio"},communismProductionBonus:{title:$I("effectsMgr.statics.communismProductionBonus.title"),
type:"ratio"},technocracyScienceCap:{title:$I("effectsMgr.statics.technocracyScienceCap.title"),type:"ratio"},aiCoreProductivness:{title:$I("effectsMgr.statics.aiCoreProductivity.title"),type:"ratio"},aiCoreUpgradeBonus:{title:$I("effectsMgr.statics.aiCoreUpgradeBonus.title"),type:"ratio"},blsProductionBonus:{title:$I("effectsMgr.statics.blsProductionBonus.title"),type:"ratio"},leviathansEnergyModifier:{title:$I("effectsMgr.statics.leviathansEnergyModifier.title"),type:"ratio"},holyGenocideBonus:{title:$I("effectsMgr.statics.holyGenocideBonus.title"),
type:"ratio"},tradeCatpowerDiscount:{title:$I("effectsMgr.statics.tradeCatpowerDiscount.title"),type:"fixed"},tradeGoldDiscount:{title:$I("effectsMgr.statics.tradeGoldDiscount.title"),type:"fixed"},zebraRelationModifier:{title:$I("effectsMgr.statics.zebraRelationModifier.title"),type:"fixed"},nonZebraRelationModifier:{title:$I("effectsMgr.statics.nonZebraRelationModifier.title"),type:"fixed"},sharedKnowledgeBonus:{title:$I("effectsMgr.statics.sharedKnowledgeBonus.title"),type:"ratio"},culturalExchangeBonus:{title:$I("effectsMgr.statics.culturalExchangeBonus.title"),
type:"ratio"},embassyCostReduction:{title:$I("effectsMgr.statics.embassyCostReduction.title"),type:"ratio"},onAHillCultureCap:{title:$I("effectsMgr.statics.onAHillCultureCap.title"),type:"ratio"},satelliteSynergyBonus:{title:$I("effectsMgr.statics.satelliteSynergyBonus.title"),type:"ratio"},globalRelationsBonus:{title:$I("effectsMgr.statics.globalRelationsBonus.title"),type:"fixed"},luxuryDemandRatio:{title:$I("effectsMgr.statics.luxuryDemandRatio.title"),type:"ratio"},breweryConsumptionRatio:{title:$I("effectsMgr.statics.breweryConsumptionRatio.title"),
type:"ratio"},luxuryHappinessBonus:{title:$I("effectsMgr.statics.luxuryHappinessBonus.title"),type:"fixed"},rationalityBonus:{title:$I("effectsMgr.statics.rationalityBonus.title"),type:"ratio"},mysticismBonus:{title:$I("effectsMgr.statics.mysticismBonus.title"),type:"ratio"},festivalLuxuryConsumptionRatio:{title:$I("effectsMgr.statics.festivalLuxuryConsumptionRatio.title"),type:"ratio"},consumableLuxuryHappiness:{title:$I("effectsMgr.statics.consumableLuxuryHappiness.title"),type:"fixed"},hapinnessConsumptionRatio:{title:$I("effectsMgr.statics.hapinnessConsumptionRatio.title"),
type:"ratio"},mintRatio:{title:$I("effectsMgr.statics.mintRatio.title"),type:"ratio"},environmentMineralBonus:{title:$I("effectsMgr.statics.environmentMineralBonus.title"),type:"ratio"},environmentWoodBonus:{title:$I("effectsMgr.statics.environmentWoodBonus.title"),type:"ratio"},environmentHappinessBonus:{title:$I("effectsMgr.statics.environmentHappinessBonus.title"),type:"fixed"},environmentUnhappiness:{title:$I("effectsMgr.statics.environmentUnhappiness.title"),type:"fixed"},environmentFactoryCraftBonus:{title:$I("effectsMgr.statics.environmentFactoryCraftBonus.title"),
type:"ratio"},coalPolicyRatio:{title:$I("effectsMgr.statics.coalPolicyRatio.title"),type:"ratio"},ironPolicyRatio:{title:$I("effectsMgr.statics.ironPolicyRatio.title"),type:"ratio"},titaniumPolicyRatio:{title:$I("effectsMgr.statics.titaniumPolicyRatio.title"),type:"ratio"},faithPolicyRatio:{title:$I("effectsMgr.statics.faithPolicyRatio.title"),type:"ratio"},unobtainiumPolicyRatio:{title:$I("effectsMgr.statics.unobtainiumPolicyRatio.title"),type:"ratio"},sciencePolicyRatio:{title:$I("effectsMgr.statics.sciencePolicyRatio.title"),
type:"ratio"},culturePolicyRatio:{title:$I("effectsMgr.statics.culturePolicyRatio.title"),type:"ratio"},mineralsPolicyRatio:{title:$I("effectsMgr.statics.mineralsPolicyRatio.title"),type:"ratio"},woodPolicyRatio:{title:$I("effectsMgr.statics.woodPolicyRatio.title"),type:"ratio"},goldPolicyRatio:{title:$I("effectsMgr.statics.goldPolicyRatio.title"),type:"ratio"},springCatnipRatio:{title:$I("effectsMgr.statics.springCatnipRatio.title"),type:"ratio"},summerSolarFarmRatio:{title:$I("effectsMgr.statics.summerSolarFarmRatio.title"),
type:"ratio"},shatterCostReduction:{title:$I("effectsMgr.statics.shatterCostReduction.title"),type:"ratio"},temporalPressCap:{title:$I("effectsMgr.statics.temporalPressCap.title"),type:"fixed"},shatterCostIncreaseChallenge:{title:$I("effectsMgr.statics.shatterCostIncreaseChallenge.title"),type:"ratio"},coldChance:{title:$I("effectsMgr.statics.coldChance.title"),type:"ratio"},coldHarshness:{title:$I("effectsMgr.statics.coldHarshness.title"),type:"ratio"},kittenLaziness:{title:$I("effectsMgr.statics.kittenLaziness.title"),
type:"ratio"},shatterVoidCost:{title:$I("effectsMgr.statics.shatterVoidCost.title"),type:"fixed"},challengeHappiness:{title:$I("effectsMgr.statics.challengeHappiness.title")},tradeKnowledge:{title:$I("effectsMgr.statics.tradeKnowledge.title")},tradeKnowledgeRatio:{title:$I("effectsMgr.statics.tradeKnowledgeRatio.title"),type:"ratio",calculation:"nonProportional"},steamworksFakeBought:{title:$I("effectsMgr.statics.steamworksFakeBought.title")},embassyFakeBought:{title:$I("effectsMgr.statics.embassyFakeBought.title")},
policyFakeBought:{title:$I("effectsMgr.statics.policyFakeBought.title")},weaponEfficency:{title:$I("effectsMgr.statics.weaponEfficency.title"),type:"ratio"},cryochamberSupport:{title:$I("effectsMgr.statics.cryochamberSupport.title")},arrivalSlowdown:{title:$I("effectsMgr.statics.arrivalSlowdown.title"),type:"ratio"},mausoleumBonus:{title:$I("effectsMgr.statics.mausoleumBonus.title"),type:"ratio"},pactsAvailable:{title:$I("effectsMgr.statics.pactsAvailable.title"),type:"fixed"},kittensKarmaPerMinneliaRatio:{title:$I("effectsMgr.statics.kittensKarmaPerMinneliaRatio.pact.title"),
type:"ratio"},necrocornPerDay:{title:$I("effectsMgr.statics.necrocornPerDay.pact.title"),type:"perDay"},pactGlobalResourceRatio:{title:$I("effectsMgr.statics.pactGlobalResourceRatio.title"),type:"ratio"},pactGlobalProductionRatio:{title:$I("effectsMgr.statics.pactGlobalProductionRatio.title"),type:"ratio"},pactFaithRatio:{title:$I("effectsMgr.statics.pactFaithRatio.title"),type:"ratio"},pyramidGlobalResourceRatio:{title:$I("effectsMgr.statics.pyramidGlobalResourceRatio.title"),type:"ratio"},pyramidGlobalProductionRatio:{title:$I("effectsMgr.statics.pyramidGlobalProductionRatio.title"),
type:"ratio"},deficitRecoveryRatio:{title:$I("effectsMgr.statics.deficitRecoveryRatio.title"),type:"ratio"},pyramidFaithRatio:{title:$I("effectsMgr.statics.pyramidFaithRatio.title"),type:"ratio"},pyramidSpaceCompendiumRatio:{title:$I("effectsMgr.statics.pyramidSpaceCompendiumRatio.title"),type:"ratio"},pactBlackLibraryBoost:{title:$I("effectsMgr.statics.pactBlackLibraryBoost.title"),type:"ratio"},pactDeficitRecoveryRatio:{title:$I("effectsMgr.statics.pactDeficitRecoveryRatio.title"),type:"ratio"},
pactSpaceCompendiumRatio:{title:$I("effectsMgr.statics.pactSpaceCompendiumRatio.title"),type:"ratio"},cathPollutionPerTickProd:{type:"hidden"},cathPollutionPerTickCon:{type:"hidden"},cathPollutionRatio:{title:$I("effectsMgr.statics.pollutionRatio.title"),type:"ratio"},zebraPreparations:{title:$I("effectsMgr.statics.zebraPreparations.title"),type:"fixed"},academyMeteorBonus:{title:$I("effectsMgr.statics.academyMeteorBonus.title"),type:"ratio"},activeHG:{title:$I("effectsMgr.statics.activeHG.title"),
type:"fixed",calculation:"nonProportional"}}}});
dojo.declare("com.nuclearunicorn.game.ui.GamePage",null,{id:null,tabs:null,resPool:null,calendar:null,bld:null,village:null,science:null,workshop:null,diplomacy:null,achievements:null,console:null,telemetry:null,server:null,math:null,loadingSave:!1,globalEffectsCached:{},ticksPerSecond:5,isPaused:!1,isCMBREnabled:!1,ticksBeforeSave:400,autosaveFrequency:400,selectedBuilding:null,setSelectedObject:function(a){this.selectedBuilding=a;this._publish("ui/update",this)},clearSelectedObject:function(){this.selectedBuilding=
null;this._publish("ui/update",this)},forceShowLimits:!1,useWorkers:!1,colorScheme:"",unlockedSchemes:null,timer:null,_mainTimer:null,karmaKittens:0,karmaZebras:0,deadKittens:0,ironWill:!0,saveVersion:15,opts:null,gatherTimeoutHandler:null,gatherClicks:0,cheatMode:!1,systemShockMode:!1,ticks:0,totalUpdateTime:[0,0,0,0,0],totalUpdateTimeTicks:5,totalUpdateTimeCurrent:0,fps:null,pauseTimestamp:0,lastDateMessage:null,effectsMgr:null,managers:null,undoChange:null,ui:null,dropBoxClient:null,isLocalhost:!1,
devMode:!1,mobileSaveOnPause:!0,winterCatnipPerTick:0,featureFlags:{VILLAGE_MAP:{beta:!0,main:!1},SPACE_EXPL:{beta:!0,main:!1},MAUSOLEUM_PACTS:{beta:!0,main:!0},QUEUE:{beta:!0,main:!0}},constructor:function(a){this.id=a;this.fps={};this.tabs=[];this.managers=[];this.opts={usePerSecondValues:!0,notation:"si",forceHighPrecision:!1,usePercentageResourceValues:!1,showNonApplicableButtons:!1,usePercentageConsumptionValues:!1,highlightUnavailable:!0,hideSell:!1,hideDowngrade:!1,hideBGImage:!1,tooltipsInRightColumn:!1,
noConfirm:!1,IWSmelter:!0,disableCMBR:!1,enableRedshift:!1,enableRedshiftGflops:!1,batchSize:10,useLegacyTwoInRowLayout:!1,forceLZ:!1,compressSaveFile:!1};this.console=new com.nuclearunicorn.game.log.Console(this);this.telemetry=new classes.game.Telemetry(this);this.server=new classes.game.Server(this);this.math=new com.nuclearunicorn.game.Math;this.resPool=new classes.managers.ResourceManager(this);this.calendar=new com.nuclearunicorn.game.Calendar(this,dojo.byId("calendarDiv"));this.village=new classes.managers.VillageManager(this);
this.resPool.setVillage(this.village);a=[{id:"workshop",class:"WorkshopManager"},{id:"diplomacy",class:"DiplomacyManager"},{id:"bld",class:"BuildingsManager"},{id:"science",class:"ScienceManager"},{id:"achievements",class:"Achievements"},{id:"religion",class:"ReligionManager"},{id:"space",class:"SpaceManager"},{id:"time",class:"TimeManager"},{id:"prestige",class:"PrestigeManager"},{id:"challenges",class:"ChallengesManager"},{id:"stats",class:"StatsManager"},{id:"void",class:"VoidManager"}];for(var b in a){var c=
a[b];if(!window.classes.managers[c.class])throw"Unable to load tab manager '"+c.class+"'";this[c.id]=new window.classes.managers[c.class](this);var d=this[c.id];d.id=c.id;this.managers.push(d)}var e=this;dojo.forEach([{class:com.nuclearunicorn.game.ui.tab.BuildingsModern,name:"buildings.tabName",id:"Bonfire",prop:"bldTab"},{class:com.nuclearunicorn.game.ui.tab.Village,name:"village.tab.title.smallvillage",id:"Village",prop:"villageTab"},{class:com.nuclearunicorn.game.ui.tab.Library,name:"tab.name.science",
id:"Science",prop:"libraryTab"},{class:com.nuclearunicorn.game.ui.tab.Workshop,name:"tab.name.workshop",id:"Workshop",prop:"workshopTab"},{class:com.nuclearunicorn.game.ui.tab.Diplomacy,name:"tab.name.trade",id:"Trade",prop:"diplomacyTab"},{class:com.nuclearunicorn.game.ui.tab.ReligionTab,name:"tab.name.religion",id:"Religion",prop:"religionTab"},{class:com.nuclearunicorn.game.ui.tab.SpaceTab,name:"tab.name.space",id:"Space",prop:"spaceTab"},{class:classes.tab.TimeTab,name:"tab.name.time",id:"Time",
prop:"timeTab"},{class:classes.tab.ChallengesTab,name:"tab.name.challenges",id:"Challenges",prop:"challengesTab"},{class:com.nuclearunicorn.game.ui.tab.AchTab,name:"tab.name.achievements",id:"Achievements",prop:"achievementTab"},{class:classes.tab.StatsTab,name:"tab.name.stats",id:"Stats",prop:"statsTab"}],function(f){var g=new f.class({name:$I(f.name),id:f.id},e);g.visible=!0;e[f.prop]=g;e.addTab(g)});this.timer=new classes.game.Timer;this.timer.addEvent(dojo.hitch(this,function(){this.village.updateResourceProduction()}),
10);b=60*this.ticksPerSecond;this.timer.addEvent(dojo.hitch(this,function(){this.achievements.update()}),50);this.timer.addEvent(dojo.hitch(this,function(){this.server.refresh()}),1440*b);this.timer.addEvent(dojo.hitch(this,function(){this.updateWinterCatnip()}),25);this.timer.addEvent(dojo.hitch(this,function(){this.ui.checkForUpdates()}),720*b);this.timer.addEvent(dojo.hitch(this,function(){this.time.updateQueue()}),10);this.effectsMgr=new com.nuclearunicorn.game.EffectsManager(this)},getFeatureFlag:function(a){var b=
window.location.hostname;if("file:"==window.location.protocol||"localhost"==b||"127.0.0.1"==b)return!0;b=0<=window.location.href.indexOf("beta");return this.featureFlags[a][b?"beta":"main"]},updateWinterCatnip:function(){this.winterCatnipPerTick=this.calcResourcePerTick("catnip",{modifiers:{catnip:.25}})},setDropboxClient:function(a){this.dropBoxClient=a},heartbeat:function(){this.telemetry.logEvent("heartbeat",{opts:this.opts,year:this.calendar.year})},getEffectMeta:function(a){var b=this.effectsMgr.effectMeta(a);
return 0!=b?b:"undefined"!=typeof this.effectsMgr.statics.effectMeta[a]?this.effectsMgr.statics.effectMeta[a]:{title:a}},getEffect:function(a){return this.globalEffectsCached[a]||0},updateCaches:function(){this.globalEffectsCached={};this.workshop.updateEffectCached();this.religion.updateEffectCached();this.bld.updateEffectCached();this.challenges.updateEffectCached();this.prestige.updateEffectCached();this.space.updateEffectCached();this.time.updateEffectCached();this.village.updateEffectCached();
this.science.updateEffectCached();this.bld.cacheCathPollutionPerTick();this.updateResources()},getLimitedDR:function(a,b){var c=Math.abs(a),d=.75*b;if(c<=d)return 0>a?-c:c;b*=.25;c=d+(1-b/(c-d+b))*b;return 0>a?-c:c},msg:function(a,b,c,d){var e=dojo.clone(this.console.filters);if(!c||!e[c]||e[c].enabled)return this.science.get("calendar").researched&&(e=$I("calendar.year.ext",[this.calendar.year.toLocaleString(),this.calendar.getCurSeasonTitle()]),this.lastDateMessage!==e&&(this.console.msg(e,"date",
null,!1),this.lastDateMessage=e)),this.console.msg(a,b,c,d)},clearLog:function(){dojo.empty("gameLog");this.console.clear();this.lastDateMessage=null},saveUI:function(){this.save();dojo.style(dojo.byId("saveTooltip"),"opacity","1");dojo.animateProperty({node:"saveTooltip",properties:{opacity:0},duration:1200}).play()},resetState:function(){this.forceShowLimits=!1;this.useWorkers=!0;this.colorScheme="";this.unlockedSchemes=this.ui.defaultSchemes;this.karmaZebras=this.karmaKittens=0;this.ironWill=!0;
this.deadKittens=0;this.isCMBREnabled=this.systemShockMode=this.cheatMode=!1;this.pauseTimestamp&&(this.pauseTimestamp=Date.now());this.opts={usePerSecondValues:!0,notation:"si",forceHighPrecision:!1,usePercentageResourceValues:!1,showNonApplicableButtons:!1,usePercentageConsumptionValues:!1,highlightUnavailable:!0,autoSaveReset:!1,hideSell:!1,hideDowngrade:!1,hideBGImage:!1,tooltipsInRightColumn:!1,noConfirm:!1,IWSmelter:!0,disableCMBR:!1,disableTelemetry:!1,enableRedshift:!1,enableRedshiftGflops:!1,
batchSize:10,useLegacyTwoInRowLayout:!1,forceLZ:!1,compressSaveFile:!1};this.resPool.resetState();this.village.resetState();this.calendar.resetState();this.ui.resetConsole();for(var a in this.managers)this.managers[a].resetState();for(a in this.tabs)"Bonfire"!=this.tabs[a].tabId&&(this.tabs[a].visible=!1);this.globalEffectsCached={}},_publish:function(a,b){6==dojo.version.minor?dojo.publish(a,[b]):dojo.publish(a,b)},reload:function(){this.save();window.location.reload()},save:function(){this.ticksBeforeSave=
this.autosaveFrequency;var a={saveVersion:this.saveVersion,resources:this.resPool.filterMetadata(this.resPool.resources,["name","value","unlocked","isHidden"])};this.server.save(a);this.resPool.save(a);this.village.save(a);this.calendar.save(a);this.console.save(a);this.telemetry.save(a);for(var b in this.managers)this.managers[b].save(a);a.game={forceShowLimits:this.forceShowLimits,isCMBREnabled:this.isCMBREnabled,useWorkers:this.useWorkers,colorScheme:this.colorScheme,unlockedSchemes:this.unlockedSchemes,
karmaKittens:this.karmaKittens,karmaZebras:this.karmaZebras,ironWill:this.ironWill,deadKittens:this.deadKittens,cheatMode:this.cheatMode,opts:this.opts,lastBackup:this.lastBackup};a=this._prepareSaveData(a);b=this._saveDataToString(a);LCstorage["com.nuclearunicorn.kittengame.savedata"]=b;this.ui.save();return a},_prepareSaveData:function(a){this._publish("game/beforesave",a);return a},_saveDataToString:function(a){a=JSON.stringify(a);if(5E6<a.length||this.opts.forceLZ)console.log("compressing the save file..."),
a=this.compressLZData(a,!0);return a},_wipe:function(){this.timer.scheduleEvent(dojo.hitch(this,function(){this.mobileSaveOnPause=!1;delete LCstorage["com.nuclearunicorn.kittengame.savedata"];delete LCstorage["com.nuclearunicorn.kittengame.language"];window.location.reload()}))},wipe:function(){var a=this;this.ui.confirm($I("wipe.confirmation.title"),$I("wipe.confirmation.msg1"),function(){a.ui.confirm($I("wipe.confirmation.title"),$I("wipe.confirmation.msg2"),function(){a._wipe()})})},closeOptions:function(){$("#optionsDiv").hide();
this.render()},toggleScheme:function(a){this.colorScheme=a;this.updateOptionsUI()},togglePause:function(){var a=dojo.byId("pauseBtn");this.isPaused=!this.isPaused;a.innerHTML=this.isPaused?$I("ui.unpause"):$I("ui.pause");this.isPaused?this.pauseTimestamp=Date.now():this.pauseTimestamp&&(this.time.gainTemporalFlux(this.pauseTimestamp),this.pauseTimestamp=0)},updateOptionsUI:function(){this.ui.updateOptions();this._publish("game/options",this)},decompressLZData:function(a){var b=LZString.decompressFromBase64(a);
return b&&"{"==b[0]?b:LZString.decompressFromUTF16(a)},compressLZData:function(a,b){return b?LZString.compressToUTF16(a):LZString.compressToBase64(a)},_parseLSSaveData:function(){var a=(a=LCstorage["com.nuclearunicorn.kittengame.savedata"])&&"{"==a[0]?a:this.decompressLZData(a);return JSON.parse(a)},load:function(){this.loadingSave=!0;var a=LCstorage["com.nuclearunicorn.kittengame.savedata"];this.resetState();if(a){var b=!0;try{var c=this._parseLSSaveData();if(c){console.log("game#load - Successfully parsed local storage data, loading tab managers...");
c.server&&(this.server.motdContentPrevious=c.server.motdContent);c.saveVersion&&c.saveVersion==this.saveVersion||this.migrateSave(c);this.resPool.load(c);this.village.load(c);this.calendar.load(c);this.console.load(c);this.telemetry.load(c);this.ui.renderFilters();for(var d in this.managers)console.log("game#load - Processing",this.managers[d].id,"..."),this.managers[d].load(c);this._publish("server/load",c)}}catch(f){console.error("Unable to load game data: ",f),6==dojo.version.minor?console.log(Error().stack):
console.trace(),this.msg("Unable to load save data. Contact the devs and provide the faulty save file.","important"),b=!1}if(c&&c.game){a=c.game;this.forceShowLimits=a.forceShowLimits?a.forceShowLimits:!1;this.colorScheme=a.colorScheme?a.colorScheme:null;this.unlockedSchemes=a.unlockedSchemes?a.unlockedSchemes:this.ui.defaultSchemes;this.karmaKittens=void 0!==a.karmaKittens?a.karmaKittens:0;this.karmaZebras=void 0!==a.karmaZebras?a.karmaZebras:0;this.deadKittens=void 0!==a.deadKittens?a.deadKittens:
0;this.ironWill=void 0!==a.ironWill?a.ironWill:!0;this.useWorkers=void 0!==a.useWorkers?a.useWorkers:!0;this.cheatMode=void 0!==a.cheatMode?a.cheatMode:!1;this.isCMBREnabled=void 0!==a.isCMBREnabled?a.isCMBREnabled:!0;this.lastBackup=a.lastBackup||(new Date).getTime();if(a.opts){for(var e in a.opts)this.opts[e]=a.opts[e];void 0==a.opts.tooltipsInRightColumn&&(this.opts.tooltipsInRightColumn="sleek"==this.colorScheme)}this.updateOptionsUI()}this.calculateAllEffects();this.villageTab.visible=0<this.bld.get("hut").on||
this.resPool.get("kittens").unlocked||this.resPool.get("zebras").unlocked||0<this.time.getVSU("usedCryochambers").val;this.libraryTab.visible=0<this.bld.get("library").on||this.science.get("calendar").researched||this.science.get("chronophysics").researched;this.workshopTab.visible=0<this.bld.get("workshop").on;this.achievementTab.visible=this.achievements.hasUnlocked();this.statsTab.visible=0<this.karmaKittens||this.science.get("math").researched;this.diplomacyTab.visible=this.diplomacy.hasUnlockedRaces();
this.religionTab.visible=0<this.resPool.get("faith").value||this.challenges.isActive("atheism")&&0<this.bld.get("ziggurat").val;this.spaceTab.visible=this.science.get("rocketry").researched;this.timeTab.visible=this.science.get("calendar").researched||0<this.time.getVSU("usedCryochambers").val;this.challengesTab.visible=this.prestige.getPerk("adjustmentBureau").researched||this.prestige.getPerk("adjustmentBureau").reserve;this.nummonTab&&(this.nummonTab.visible=!0);this.ui.load();this.village.updateResourceProduction();
this.updateCaches();this.resPool.update();this.updateWinterCatnip();this.loadingSave=!1;return b}this.loadingSave=!1;this.calculateAllEffects();this.updateOptionsUI()},saveExport:function(){var a=this.save();a=JSON.stringify(a);a=this.compressLZData(a);this.ui.saveExport(a)},saveImport:function(a){var b=this;this.ui.confirm("",$I("save.import.confirmation.msg"),function(){var c=a?a.replace(/\s/g,""):$("#importData").val().replace(/\s/g,"");c&&b.saveImportDropboxText(c,function(d){$("#importDiv").hide();
$("#optionsDiv").hide()})});b.nummonTab&&(b.nummonTab.visible=!0)},saveToFile:function(a){var b=$("#download-link"),c=JSON.stringify(this.save());c=this.compressLZData(c);c=new Blob([c],{type:"text/plain"});b.attr("href",window.URL.createObjectURL(c));c="Kittens Game";"zh"==localStorage["com.nuclearunicorn.kittengame.language"]&&(c="\u732b\u56fd\u5efa\u8bbe\u8005");a&&(c+=" - "+(this.stats.getStat("totalResets").val+1)+" \u5468\u76ee - "+$I("calendar.year.full",[this.calendar.year,this.calendar.getCurSeasonTitle(),
Math.floor(this.calendar.day)]));b.attr("download",c+".txt");b.get(0).dispatchEvent(new MouseEvent("click"))},saveExportDropbox:function(){this.save();var a=this.save();a=JSON.stringify(a);a=this.compressLZData(a);this.exportToDropbox(a,function(){$("#exportDiv").hide();$("#optionsDiv").hide()})},getDropboxAuthUrl:function(){var a="/games/kittens/dropboxauth_v2.html";-1<window.location.host.indexOf("kittensgame")&&(a="/dropboxauth_v2.html");return this.dropBoxClient.getAuthenticationUrl("https://"+
window.location.host+a)},exportToDropbox:function(a,b){var c=this,d=c.getDropboxAuthUrl();window.open(d,"DropboxAuthPopup","dialog=yes,dependent=yes,scrollbars=yes,location=yes");var e=function(f){window.removeEventListener("message",e);window.location.origin!==f.origin?b("Unable to save file"):(new Dropbox.Dropbox({accessToken:f.data["#access_token"]})).filesUpload({path:"/kittens.save",contents:a,mode:"overwrite"}).then(function(g){c.msg($I("save.export.msg"));b()}).catch(function(g){b("Unable to save file:"+
JSON.stringify(g))})};window.addEventListener("message",e,!1)},saveImportDropbox:function(){var a=this;this.ui.confirm("",$I("save.import.confirmation.msg"),function(){a.importFromDropbox(function(b){$("#importDiv").hide();$("#optionsDiv").hide()})})},importFromDropbox:function(a){var b=this,c=b.getDropboxAuthUrl();window.open(c,"DropboxAuthPopup","dialog=yes,dependent=yes,scrollbars=yes,location=yes");var d=function(e){window.removeEventListener("message",d);window.location.origin!==e.origin?a("Unable to load file"):
(new Dropbox.Dropbox({accessToken:e.data["#access_token"]})).filesDownload({path:"/kittens.save"}).then(function(f){f=f.fileBlob;var g=new FileReader;g.addEventListener("loadend",function(){b.saveImportDropboxText(g.result,a)});g.readAsText(f)}).catch(function(f){a("Unable to load file:"+JSON.stringify(f))})};window.addEventListener("message",d,!1)},saveImportDropboxFileRead:function(a){var b=this;this.dropBoxClient.readFile("kittens.save",{},function(c,d){c?a(c):b.saveImportDropboxText(d,a)})},saveImportDropboxText:function(a,
b){this.timer.scheduleEvent(dojo.hitch(this,this._loadSaveJson,a,b))},_loadSaveJson:function(a,b){try{var c=this.decompressLZData(a);if(c&&"{"==c[0])LCstorage["com.nuclearunicorn.kittengame.savedata"]=a;else throw"Integrity check failure";this.loadingSave=!0;var d=this.colorScheme;this.load();this.loadingSave=!1;this.msg($I("save.import.msg"));this.render();var e=this.colorScheme;e&&e!=d&&$("<link />").attr("rel","stylesheet").attr("type","text/css").attr("href","res/theme_"+e+".css?_="+buildRevision).appendTo($("head"));
b()}catch(f){console.log("Couldn't import the save of the game:",f.stack),b(f)}},migrateSave:function(a){void 0===a.saveVersion&&(a.saveVersion=1);if(1==a.saveVersion){if(a.space&&a.space.programs&&a.space.planets){for(var b=[],c=0;c<a.space.programs.length;c++){var d=a.space.programs[c];if("moonOutpost"==d.name||"moonBase"==d.name)d.unlocked=!0,b.push(d),a.space.programs.splice(c,1),c--}for(c=0;c<a.space.planets.length;c++)if("moon"==a.space.planets[c].name){a.space.planets[c].buildings=b;break}}a.saveVersion=
2}if(2==a.saveVersion){if(a.space&&a.space.programs&&a.space.planets){b=[];for(c=0;c<a.space.programs.length;c++)if(d=a.space.programs[c],"spaceElevator"==d.name||"sattelite"==d.name||"spaceStation"==d.name)d.unlocked=!0,b.push(d),a.space.programs.splice(c,1),c--;a.space.planets.push({name:"cath",buildings:b})}a.saveVersion=3}if(3==a.saveVersion){if(a.buildings)for(c=0;c<a.buildings.length;c++)a.buildings[c].on=a.buildings[c].val;a.saveVersion=4}if(4==a.saveVersion){if(a.religion&&a.religion.ru)for(c=
0;c<a.religion.ru.length;c++)b=a.religion.ru[c],!b.researched||0!=b.val&&null!=b.val||(b.val=1),b.on=b.val;if(a.space){if(a.space.programs)for(c=0;c<a.space.programs.length;c++)a.space.programs[c].researched&&(a.space.programs[c].on=1,a.space.programs[c].val=1);if(a.space.planets)for(c=0;c<a.space.planets.length;c++)if(b=a.space.planets[c],b.buildings)for(var e=0;e<b.buildings.length;e++)d=b.buildings[e],d.on=d.val}a.saveVersion=5}if(5==a.saveVersion){if(a.time&&a.time.energy&&a.resources){b=!1;for(c=
0;c<a.resources.length;c++)if(d=a.resources[c],"temporalFlux"==d.name){d.value=a.time.energy;b=!0;break}b||(b={name:"temporalFlux",title:$I("resources.temporalFlux.title"),description:"",type:"exotic",craftable:!1,visible:!1,persists:!0,value:a.time.energy},a.resources.push(b))}a.saveVersion=6}if(6==a.saveVersion){if(a.religion){if(a.religion.zu)for(c=0;c<a.religion.zu.length;c++)a.religion.zu[c].on=a.religion.zu[c].val;if(a.religion.tu)for(c=0;c<a.religion.tu.length;c++)a.religion.tu[c].on=a.religion.tu[c].val}if(a.time){if(a.time.usedCryochambers)for(c=
0;c<a.time.usedCryochambers.length;c++)a.time.usedCryochambers[c].on=a.time.usedCryochambers[c].val;if(a.time.cfu)for(c=0;c<a.time.cfu.length;c++)a.time.cfu[c].on=a.time.cfu[c].val;if(a.time.vsu)for(c=0;c<a.time.vsu.length;c++)a.time.vsu[c].on=a.time.vsu[c].val}a.saveVersion=8}8==a.saveVersion&&("undefined"==typeof a.challenges&&(a.challenges=[]),a.challenges.currentChallenge=null,a.saveVersion=9);if(9==a.saveVersion){if(a.buildings)for(c=0;c<a.buildings.length;c++)a.buildings[c].unlockable=a.buildings[c].unlocked,
a.buildings[c].unlocked=!1;if(a.space&&a.space.programs)for(c=0;c<a.space.programs.length;c++)"rorschachMission"==a.space.programs[c].name&&1==a.space.programs[c].on&&a.space.programs.push({name:"centaurusSystemMission",val:0,on:0,unlocked:!0});a.saveVersion=10}if(10==a.saveVersion){if(a.resources)for(c=0;c<a.resources.length;c++)a.resources[c].unlocked=!1;a.saveVersion=11}if(11==a.saveVersion){"undefined"==typeof a.challenges&&(a.challenges=[]);if(a.religion&&a.religion.ru)for(c=0;c<a.religion.ru.length;c++)if("transcendence"==
a.religion.ru[c].name&&1==a.religion.ru[c].on){"undefined"==typeof a.challenges.challenges&&(a.challenges.challenges=[]);a.challenges.challenges.push({name:"atheism",researched:!1,unlocked:!0});break}a.saveVersion=12}if(12==a.saveVersion){if(a.religion&&a.religion.tcratio&&a.religion.tu)for(b=Math.max(0,Math.round(Math.log(10*this.game.getUnlimitedDR(a.religion.tcratio,.1)))),c=0;c<a.religion.tu.length;c++)b>=this.religion.getTU(a.religion.tu[c].name).tier&&(a.religion.tu[c].unlocked=!0);a.saveVersion=
13}if(13==a.saveVersion){if(a.challenges&&a.challenges.challenges)for(c=0;c<a.challenges.challenges.length;c++)if("atheism"==a.challenges.challenges[c].name&&(a.challenges.challenges[c].unlocked=!1,a.science&&a.science.techs))for(e=0;e<a.science.techs.length;e++)"voidSpace"==a.science.techs[e].name&&1==a.science.techs[e].researched&&(a.challenges.challenges[c].unlocked=!0);a.saveVersion=14}if(14==a.saveVersion){if(a.space&&a.space.planets)for(c in a.space.planets)if(b=a.space.planets[c],b.buildings)for(e in b.buildings)d=
b.buildings[e],d.unlockable="undefined"!=typeof d.unlocked?d.unlocked:!1;a.saveVersion=15}return a},setUI:function(a){this.ui=a;a.setGame(this);this.console.ui=a},render:function(a){if(!this.ui)throw"Unable to render game state, no UI manager";this.ui.render();this.updateCaches();a&&this.update();this.calendar.update()},calcResourcePerTick:function(a,b){b=this.resPool.get(a);var c=this.getEffect(b.name+"PerTickBase"),d=1+this.getEffect("spaceRatio");if(this.workshop.get("spaceManufacturing").researched&&
"uranium"!=b.name){var e=this.bld.get("factory");d*=1+e.on*e.effects.craftRatio*.75}e=this.getEffect(b.name+"PerTickBaseSpace")*d;c=(c+e)*this.calendar.getWeatherMod(b);e=this.village.getResProduction();e=e[b.name]?e[b.name]:0;var f=this.religion.getHGScalingBonus();e*=f;c+=e;f=this.getEffect(b.name+"JobRatio");c=(c+e*f)*(1+this.getEffect(b.name+"GlobalRatio"));c*=1+this.getEffect(b.name+"Ratio");c*=1+this.getEffect(b.name+"RatioReligion");c*=1+this.getEffect(b.name+"SuperRatio");f=this.bld.get("steamworks");
e=f.effects[b.name+"RatioGlobal"];0<f.on&&e&&(c*=1+e);e=this.prestige.getParagonProductionRatio();"catnip"==a&&this.challenges.isActive("winterIsComing")&&(e=0);c*=1+e;"catnip"==b.name&&(c*=1+this.bld.pollutionEffects.catnipPollutionRatio);e=1+.05*e;f=this.getEffect(b.name+"PerTickAutoprod");f=f*e*(1+this.getEffect("rankLeaderBonusConversion")*(this.village.leader?this.village.leader.rank:0));c+=f;!b.transient&&0<this.bld.get("magneto").on&&"catnip"!=b.name&&(f=this.bld.get("steamworks"),f=0<f.on?
1+f.effects.magnetoBoostRatio*f.on:1,"oil"!=b.name&&(c*=1+this.getEffect("magnetoRatio")*f),e+=e*this.getEffect("magnetoRatio")*f);b.transient||"uranium"==b.name||"catnip"==b.name||(c*=1+this.getEffect("productionRatio"),e+=e*this.getEffect("productionRatio"));c*=1+this.religion.getSolarRevolutionRatio()*(1+("wood"==b.name||"catnip"==b.name?this.bld.pollutionEffects.solarRevolutionPollution:0));this.opts.disableCMBR||"coal"==b.name||(c*=1+this.getCMBRBonus());e*=1+this.religion.getSolarRevolutionRatio();
c+=this.getEffect(b.name+"PerTickProd");c+=this.getEffect(b.name+"PerTickAutoprodSpace")*d*(1+(e-1)*this.getEffect("prodTransferBonus"));c+=this.getEffect(b.name+"PerTickSpace")*d;d={};d[a]=c;this.calendar.cycleEffectsFestival(d);c=d[a];c+=this.getEffect(b.name+"PerTick")*(1+this.getEffect(b.name+"PerTickRatio"));a=this.village.getResConsumption()[b.name]||0;a*=1+this.getEffect(b.name+"DemandRatio");"catnip"==b.name&&0<this.village.sim.kittens.length&&1<this.village.happiness&&(d=Math.max(this.village.happiness*
(1+this.getEffect("hapinnessConsumptionRatio"))-1,0),a=this.challenges.isActive("anarchy")?a+a*d*(1+this.getEffect(b.name+"DemandWorkerRatioGlobal")):a+a*d*(1+this.getEffect(b.name+"DemandWorkerRatioGlobal"))*(1-this.village.getFreeKittens()/this.village.sim.kittens.length));c*=1+this.resPool.get("sorrow").value*this.getEffect("blsProductionBonus");d=this.getEffect("pyramidGlobalProductionRatio");c*=1+d;"faith"==b.name&&(d=this.getEffect("pyramidFaithRatio"),c*=1+d);c*=1+this.getEffect(b.name+"PolicyRatio");
c+=a;return isNaN(c)?0:c},addGlobalModToStack:function(a,b){this.science.getPolicy("necrocracy").researched&&a.push({name:$I("res.stack.necrocracy"),type:"ratio",value:this.getEffect("blsProductionBonus")*this.resPool.get("sorrow").value});a.push({name:$I("res.stack.policy"),type:"ratio",value:this.getEffect(b+"PolicyRatio")});a.push({name:$I("res.stack.destruction"),type:"ratio",value:this.getEffect("pyramidGlobalProductionRatio")});return a},getResourcePerTickStack:function(a,b,c){b=[];c=null;for(var d in this.resPool.resources){var e=
this.resPool.resources[d];if(e.name==a){c=e;break}}if(c){b.push({name:$I("res.stack.production"),type:"fixed",value:this.getEffect(c.name+"PerTickBase")});d=1+this.getEffect("spaceRatio");this.workshop.get("spaceManufacturing").researched&&"uranium"!=c.name&&(e=this.bld.get("factory"),d*=1+e.on*e.effects.craftRatio*.75);e=[];e.push({name:$I("res.stack.spaceProduction"),type:"fixed",value:this.getEffect(c.name+"PerTickBaseSpace")});e.push({name:$I("res.stack.spaceProductionBonus"),type:"ratio",value:d-
1});this.addGlobalModToStack(e,a);b.push(e);b.push({name:$I("res.stack.weather"),type:"ratio",value:this.calendar.getWeatherMod(c)-1});e=this.village.getResProduction();var f=this.religion.getHGScalingBonus()-1,g=[];g.push({name:$I("res.stack.village"),type:"fixed",value:e[c.name]||0});g.push({name:$I("res.stack.holyGenocide"),type:"ratio",value:f});g.push({name:$I("res.stack.tools"),type:"ratio",value:this.getEffect(c.name+"JobRatio")});b.push(g);b.push({name:$I("res.stack.upgrades"),type:"ratio",
value:this.getEffect(c.name+"GlobalRatio")});b.push({name:$I("res.stack.buildings"),type:"ratio",value:this.getEffect(c.name+"Ratio")});b.push({name:$I("res.stack.religion"),type:"ratio",value:this.getEffect(c.name+"RatioReligion")});b.push({name:$I("res.stack.boost"),type:"ratio",value:this.getEffect(c.name+"SuperRatio")});f=this.bld.get("steamworks");e=f.effects[c.name+"RatioGlobal"];0<f.on&&e&&b.push({name:$I("res.stack.steamworks"),type:"ratio",value:e});f=this.prestige.getParagonProductionRatio();
"catnip"==a&&this.challenges.isActive("winterIsComing")&&(f=0);b.push({name:$I("res.stack.paragon"),type:"ratio",value:f});"catnip"==c.name&&b.push({name:$I("res.stack.pollution"),type:"ratio",value:this.bld.pollutionEffects.catnipPollutionRatio});e=1+.05*f;g=this.getEffect("rankLeaderBonusConversion")*(this.village.leader?this.village.leader.rank:0);var h=[];h.push({name:$I("res.stack.convProd"),type:"fixed",value:this.getEffect(c.name+"PerTickAutoprod")});h.push({name:$I("res.stack.paragon"),type:"ratio",
value:.05*f});h.push({name:$I("res.stack.rankLeaderBonusConversion"),type:"ratio",value:g});b.push(h);!c.transient&&0<this.bld.get("magneto").on&&"catnip"!=c.name&&(f=this.bld.get("steamworks"),f=0<f.on?1+f.effects.magnetoBoostRatio*f.on:1,"oil"!=c.name&&b.push({name:$I("res.stack.magnetos"),type:"ratio",value:this.getEffect("magnetoRatio")*f}),e+=e*this.getEffect("magnetoRatio")*f);c.transient||"uranium"==c.name||"catnip"==c.name||(b.push({name:$I("res.stack.reactors"),type:"ratio",value:this.getEffect("productionRatio")}),
e+=e*this.getEffect("productionRatio"));b.push({name:$I("res.stack.solarRevolution"),type:"ratio",value:this.religion.getSolarRevolutionRatio()});("wood"==c.name||"catnip"==c.name)&&0<this.religion.getSolarRevolutionRatio()&&b.push({name:$I("res.stack.pollution"),type:"ratioIndent",value:this.bld.pollutionEffects.solarRevolutionPollution});this.opts.disableCMBR||"coal"==c.name||b.push({name:"CMBR",type:"ratio",value:this.getCMBRBonus()});e*=1+this.religion.getSolarRevolutionRatio();this.science.getPolicy("necrocracy").researched&&
b.push({name:$I("res.stack.necrocracy"),type:"ratio",value:this.getEffect("blsProductionBonus")*this.resPool.get("sorrow").value});f=this.getEffect("pyramidGlobalProductionRatio");b.push({name:$I("res.stack.destruction"),type:"ratio",value:f});f=this.getEffect("pyramidFaithRatio");"faith"==c.name&&b.push({name:$I("res.stack.extermination"),type:"ratio",value:f});b.push({name:$I("res.stack.policy"),type:"ratio",value:this.getEffect(c.name+"PolicyRatio")});b.push({name:$I("res.stack.convProd"),type:"fixed",
value:this.getEffect(c.name+"PerTickProd")});b.push({name:$I("res.stack.convCons"),type:"fixed",value:this.getEffect(c.name+"PerTickCon")});f=[];g=[];f.push({name:$I("res.stack.spaceConvProd"),type:"fixed",value:this.getEffect(c.name+"PerTickAutoprodSpace")});this.addGlobalModToStack(f,a);f.push({name:$I("res.stack.spaceProdBonus"),type:"ratio",value:d-1});g.push({name:$I("res.stack.spaceParagon"),type:"ratio",value:e-1});g.push({name:$I("res.stack.bonusTransf"),type:"multiplier",value:this.getEffect("prodTransferBonus")});
f.push(g);b.push(f);e=[];e.push({name:$I("res.stack.spaceConvProd"),type:"fixed",value:this.getEffect(c.name+"PerTickSpace")});e.push({name:$I("res.stack.spaceProdBonus"),type:"ratio",value:d-1});this.addGlobalModToStack(e,a);b.push(e);d={};d[c.name]=1;this.calendar.cycleEffectsFestival(d);d=d[a]-1;b.push({name:$I("res.stack.festival"),type:"ratio",value:d});d=[];d.push({name:$I("res.stack.baseline"),type:"fixed",value:this.getEffect(c.name+"PerTick")});d.push({name:$I("res.stack.baselineRatio"),
type:"ratio",value:this.getEffect(c.name+"PerTickRatio")});this.addGlobalModToStack(d,a);b.push(d);b.push({name:$I("res.stack.engineer"),type:"fixed",value:this.workshop.getEffectEngineer(c.name,!0)});a=this.village.getResConsumption()[c.name]||0;a*=1+this.getEffect(c.name+"DemandRatio");"catnip"==c.name&&0<this.village.sim.kittens.length&&1<this.village.happiness&&(d=Math.max(this.village.happiness*(1+this.getEffect("hapinnessConsumptionRatio"))-1,0),a=this.challenges.isActive("anarchy")?a+a*d*(1+
this.getEffect(c.name+"DemandWorkerRatioGlobal")):a+a*d*(1+this.getEffect(c.name+"DemandWorkerRatioGlobal"))*(1-this.village.getFreeKittens()/this.village.sim.kittens.length));b.push({name:$I("res.stack.demand"),type:"fixed",value:a});b.push({name:$I("res.stack.time"),type:"ratio",value:this.timeAccelerationRatio()});return b}},getResourcePerDayStack:function(a){var b=[],c=null,d;for(d in this.resPool.resources){var e=this.resPool.resources[d];if(e.name==a){c=e;break}}if(c)return b.push({name:$I("res.stack.buildings"),
type:"perDay",value:this.getEffect(c.name+"PerDay")-this.religion.pactsManager.getSiphonedCorruption(1)}),"necrocorn"==a&&(a=[],a.push({name:$I("res.stack.corruptionPerDay"),type:"perDay",value:this.religion.getCorruptionPerTick()*this.calendar.ticksPerDay}),a.push({name:$I("res.stack.corruptionPerDayProduction"),type:"perDay",value:this.religion.getCorruptionPerTickProduction()*this.calendar.ticksPerDay}),a.push({name:$I("res.stack.corruptionPerDaySiphoned"),type:"perDay",value:-this.religion.pactsManager.getSiphonedCorruption(1)}),
b.push(a),b.push({name:$I("res.stack.time"),type:"ratio",value:this.timeAccelerationRatio()})),b},getResourceOnYearStack:function(a){var b=[],c=null,d;for(d in this.resPool.resources){var e=this.resPool.resources[d];if(e.name==a){c=e;break}}if(c)return b.push({name:$I("res.stack.buildings"),type:"perYear",value:this.getEffect(c.name+"Production")}),"antimatter"==a&&this.resPool.energyProd<this.resPool.energyCons&&b.push({name:$I("ui.energy.tooltip"),type:"perYear",value:-this.getEffect(c.name+"Production")}),
b},getCMBRBonus:function(){return this.isCMBREnabled?.2:0},getCraftRatio:function(a){return this.getEffect("craftRatio")+this.village.getEffectLeader("engineer",0)+this.village.getEffectLeader(a,0)},getResCraftRatio:function(a){if("wood"==a)return a=this.getEffect("refineRatio"),this.ironWill?(1+a)*(1+this.getEffect("woodRatio"))-1:a;var b=this.getCraftRatio(this.resPool.get(a).tag);if("blueprint"==a){var c=this.getEffect("cadBlueprintCraftRatio"),d=this.bld.get("library").val+this.bld.get("academy").val+
this.bld.get("observatory").val+this.bld.get("biolab").val;b+=d*c}"kerosene"==a&&(c=.75*this.getEffect("factoryRefineRatio"),d=this.bld.get("factory").on,b*=1+d*c);b+=this.getEffect(a+"CraftRatio")||0;return b*=1+this.getEffect(a+"GlobalCraftRatio")||0},update:function(){this.ticksBeforeSave--;0==this.ticksBeforeSave&&(this.save(),this.ui.displayAutosave());this.timer.beforeUpdate();this.updateModel();this.time.isAccelerated&&0==this.ticks%2&&this.updateModel();this.time.update();this.undoChange&&
(this.undoChange.ttl--,0>=this.undoChange.ttl&&(this.undoChange=null));this.ui.update();this.timer.afterUpdate()},getTicksPerSecondUI:function(){return this.ticksPerSecond*(1+this.timeAccelerationRatio())},timeAccelerationRatio:function(){return this.time.isAccelerated?.5:0},updateModel:function(){this.resPool.update();this.bld.update();this.village.maxKittens=Math.floor(this.getEffect("maxKittens"));this.village.update();this.workshop.update();this.diplomacy.update();this.religion.update();this.space.update();
this.challenges.update();this.resPool.resConsHackForResTable();this.bld.cathPollution+=this.bld.cathPollutionPerTick;0>this.bld.cathPollution&&(this.bld.cathPollution=0);var a=this.resPool.get("kittens");a.value=this.village.getKittens();a.maxValue=this.village.sim.maxKittens;this.timer.update()},huntAll:function(a){a.preventDefault();this.village.huntAll()},praise:function(a){a.preventDefault();this.religion.praise()},updateResources:function(){for(var a=0;a<this.resPool.resources.length;a++){var b=
this.resPool.resources[a];b.calculatePerTick&&(b.perTickCached=this.fixFloatPointNumber(this.calcResourcePerTick(b.name)))}},getResourcePerTick:function(a,b){a=this.resPool.get(a);return a.calculatePerTick?b?a.perTickCached+this.getResourcePerTickConvertion(a.name):a.perTickCached:0},getResourcePerDay:function(a){return"necrocorn"==a?this.religion.pactsManager.getNecrocornDeficitConsumptionModifier()*this.getEffect(a+"PerDay")+this.religion.pactsManager.getSiphonedCorruption(1)+this.religion.getCorruptionPerTick()*
this.calendar.ticksPerDay:this.getEffect(a+"PerDay")},getResourceOnYearProduction:function(a){return"antimatter"==a?this.resPool.energyProd>=this.resPool.energyCons?this.getEffect("antimatterProduction"):0:this.getEffect(a+"Production")},getResourcePerTickConvertion:function(a){return this.fixFloatPointNumber(this.getEffect(a+"PerTickCon"))},craft:function(a,b){this.workshop.craft(a,b);this.updateResources()},craftAll:function(a){if("wood"!=a||0<this.getResourcePerTick("catnip",!0))this.workshop.craftAll(a),
this.updateResources();else{var b=this;this.ui.confirm($I("kittens.craft.confirmation.title"),$I("kittens.craft.confirmation.msg"),function(){b.workshop.craftAll(a);b.updateResources()})}},getRequiredResources:function(a){var b=[];if(a&&a.prices)for(var c=0;c<a.prices.length;c++)b.push(a.prices[c].name);return b},attachResourceTooltip:function(a,b){UIUtils.attachTooltip(this,a,0,100,function(){return 0!=this.getResourcePerTick(b.name,!1)||0!=this.getResourcePerTickConvertion(b.name)||0!=this.workshop.getEffectEngineer(b.name)||
0!=this.getResourcePerDay(b.name)||0!=this.getResourceOnYearProduction(b.name)||"antimatter"==b.name||"kittens"==b.name&&this.village.sim.kittens.length<this.village.sim.maxKittens?this.getDetailedResMap(b):""});dojo.connect(a,"onmouseover",this,function(){dojo.style(a,"fontWeight","bold")});dojo.connect(a,"onmouseout",this,function(){dojo.style(a,"fontWeight","normal")})},getDetailedResMap:function(a){if(a.calculatePerDay){var b=this.getResourcePerDayStack(a.name);b=this.processResourcePerTickStack(b,
a,0);var c=this.getResourcePerDay(a.name);this.opts.usePercentageResourceValues&&(b+="<br> "+$I("res.netGain")+": "+this.getDisplayValueExt(c,!0,!0));0>c&&(c=this.calendar.ticksPerDay*a.value/(-c*this.getTicksPerSecondUI()*(1+this.timeAccelerationRatio())),b+="<br>"+$I("res.toZero")+": "+this.toDisplaySeconds(c.toFixed()));"necrocorn"==a.name&&(a=(1-this.religion.corruption)/(5*this.religion.getCorruptionPerTick()*(1+this.timeAccelerationRatio())),0<a&&(b+="<br>"+$I("res.toNextNecrocorn")+": "+this.toDisplaySeconds(a.toFixed())));
return b}if(a.calculateOnYear)return b=this.getResourceOnYearStack(a.name),b=this.processResourcePerTickStack(b,a,0),c=this.getResourceOnYearProduction(a.name),this.opts.usePercentageResourceValues&&(b+="<br> "+$I("res.netGain")+": "+this.getDisplayValueExt(c,!0,!0)),"antimatter"==a.name&&c&&this.resPool.energyWinterProd<this.resPool.energyCons&&(b+="<br> "+$I("effectsMgr.winterEnergy.warning.title")),b;if("kittens"==a.name)return a=this.village.sim.nextKittenProgress,c=this.village.calculateKittensPerTick(),
b=" ["+(100*a).toFixed()+"%]",b+="<br>"+$I("res.toNextKitten")+" "+this.toDisplaySeconds(.2*(1-a)/c);b=this.getResourcePerTickStack(a.name);b=this.processResourcePerTickStack(b,a,0);c=this.getResourcePerTick(a.name,!0);this.opts.usePercentageResourceValues&&(b+="<br> "+$I("res.netGain")+": "+this.getDisplayValueExt(c,!0,!0));0>c?(c=a.value/(-c*this.getTicksPerSecondUI()),b+="<br>"+$I("res.toZero")+": "+this.toDisplaySeconds(c.toFixed())):a.maxValue&&a.value<a.maxValue&&(a=(a.maxValue-a.value)/(c*
this.getTicksPerSecondUI()))&&(b+="<br>"+$I("res.toCap")+": "+this.toDisplaySeconds(a.toFixed()));return b},processResourcePerTickStack:function(a,b,c,d){var e="";2>c&&(d=!1);for(var f=0;f<a.length;f++){var g=a[f];if(g.length)g=this.processResourcePerTickStack(g,b,c+1,d),g.length&&(e+=g,d=!0);else if(g.value&&("fixed"==g.type||"perDay"==g.type||"perYear"==g.type||d)){for(var h=0==f?c-1:c,m=0;m<h-1;m++)e+="<span style='visibility: hidden;'>|-> </span>";0<h&&(e+="|-> ");e+=this.getStackElemString(g,
b);if("fixed"==g.type||"perDay"==g.type)d=!0}}return e},getStackElemString:function(a,b){b=a.name+':&nbsp;<div style="float: right;">';"fixed"==a.type?b+=this.getDisplayValueExt(a.value,!0,!0):"ratio"==a.type?b+=this.getDisplayValueExt((100*a.value).toFixed(),!0)+"%":"multiplier"==a.type?b+="\u00d7"+this.getDisplayValueExt((100*a.value).toFixed())+"%":"ratioIndent"==a.type?b="|->"+b+this.getDisplayValueExt((100*a.value).toFixed(),!0)+"%":"perDay"==a.type?(0<a.value&&(b+="+"),b+=this.getDisplayValueExt(a.value)+
"/"+$I("res.per.day")):"perYear"==a.type&&(0<a.value&&(b+="+"),b+=this.getDisplayValueExt(a.value)+"/"+$I("res.per.year"));return b+"</div><br>"},toDisplaySeconds:function(a){var b=parseInt(a,10);a=Math.floor(b/31536E3);var c=Math.floor((b-31536E3*a)/86400),d=Math.floor((b-31536E3*a-86400*c)/3600),e=Math.floor((b-31536E3*a-(86400*c+3600*d))/60);b=b-31536E3*a-86400*c-3600*d-60*e;0<a&&(a=this.getDisplayValueExt(a));var f="";a&&(f=a+$I("unit.y")+" ");c&&(f+=c+$I("unit.d")+" ");a||(d&&(f+=d+$I("unit.h")+
" "),e&&(f+=e+$I("unit.m")+" "),b&&(f+=b+$I("unit.s")+" "));return f},toDisplayDays:function(a){var b=parseInt(a,10),c=this.calendar.daysPerSeason*this.calendar.seasonsPerYear;a=Math.floor(b/c);b-=a*c;0<a&&(a=this.getDisplayValueExt(a));c="";a&&(c=a+$I("unit.y")+" ");b&&(c+=b+$I("unit.d")+" ");return c},toDisplayPercentage:function(a,b,c){a*=100;c?(a-=1/Math.pow(10,b),0>a&&(a=0)):(a=this.fixFloatPointNumber(a),0!=a-Math.floor(a)&&(b=1,0!=10*a-Math.floor(10*a)&&(b=2,0!=100*a-Math.floor(100*a)&&(b=
3,0!=1E3*a-Math.floor(1E3*a)&&(b=4,0!=1E4*a-Math.floor(1E4*a)&&(b=5,0!=1E5*a-Math.floor(1E5*a)&&(b=6,0!=1E6*a-Math.floor(1E6*a)&&(b=7,0!=1E7*a-Math.floor(1E7*a)&&(b=8)))))))));return a.toFixed(b)},postfixes:[{limit:1E210,divisor:1E210,postfix:["Q"," Quita"]},{limit:1E42,divisor:1E42,postfix:["W"," Wololo"]},{limit:1E39,divisor:1E39,postfix:["L"," Lotta"]},{limit:1E36,divisor:1E36,postfix:["F"," Ferro"]},{limit:1E33,divisor:1E33,postfix:["H"," Helo"]},{limit:1E30,divisor:1E30,postfix:["S"," Squilli"]},
{limit:1E27,divisor:1E27,postfix:["U"," Umpty"]},{limit:1E24,divisor:1E24,postfix:["Y"," Yotta"]},{limit:1E21,divisor:1E21,postfix:["Z"," Zeta"]},{limit:1E18,divisor:1E18,postfix:["E"," Exa"]},{limit:1E15,divisor:1E15,postfix:["P"," Peta"]},{limit:1E12,divisor:1E12,postfix:["T"," Tera"]},{limit:1E9,divisor:1E9,postfix:["G"," Giga"]},{limit:1E6,divisor:1E6,postfix:["M"," Mega"]},{limit:9E3,divisor:1E3,postfix:["K"," Kilo"]}],getDisplayValueExt:function(a,b,c,d,e){if(!a)return"0";if(Infinity===a)return"\u221e";
(c&=this.opts.usePerSecondValues)&&(a*=this.ticksPerSecond);e=e||"";switch(this.opts.notation){case "e":var f=Math.floor(Math.log10(a));4<=f&&(a/=Math.pow(10,f),e="e"+f);break;case "sie":f=Math.floor(Math.log10(a));9E3>a?e="":9E3<=a&&6>f?(a/=1E3,e="K"):6<=f&&9>f?(a/=1E6,e="M"):9<=f&&12>f?(a/=1E9,e="G"):12<=f&&15>f?(a/=1E12,e="T"):(a/=Math.pow(10,f),e="e"+f);break;default:f=Math.abs(a);for(var g=0;g<this.postfixes.length;g++){var h=this.postfixes[g];if(f>=h.limit&&Infinity!=f)return c&&(a/=this.ticksPerSecond),
this.getDisplayValueExt(a/h.divisor,b,c,d,e+h.postfix[0])}}return this.getDisplayValue(a,b,d)+e+(c?"/"+$I("unit.sec"):"")},getDisplayValue:function(a,b,c){var d="+";if(0>=a||!b)d="";if(!a.toFixed)return d+a;void 0===c&&(c=this.opts.forceHighPrecision?3:2);b="";if(0!=a){var e=Math.abs(a);if(.01>e&&2==c||.001>e&&3==c)b="(...)"}if(0===a%1)return a=a.toFixed(),d+a;a=a.toFixed(c);return d+a+b},fixFloatPointNumber:function(a){var b=Math.floor(1E7*a)/1E7;Math.round(1E7*(a-b))&&(b=Math.floor(1E7*(a+1E-14))/
1E7);return b},addTab:function(a){this.tabs.push(a);a.game=this},getTabById:function(a){for(var b in this.tabs)if(this.tabs[b].id==a)return this.tabs[b]},isWebWorkerSupported:function(){return!dojo.isIE&&window.Worker},timestamp:function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},start:function(){if(this.isWebWorkerSupported()&&this.useWorkers){console.log("starting web worker...");var a=new Blob(["onmessage = function(e) { setInterval(function(){ postMessage('tick'); }, 1000 / "+
this.ticksPerSecond+"); }"]);a=window.URL.createObjectURL(a);this.worker=new Worker(a);this.worker.addEventListener("message",dojo.hitch(this,function(b){this.tick()}));this.worker.postMessage("tick")}else console.log("starting js timer..."),clearInterval(this._mainTimer),this._mainTimer=setInterval(dojo.hitch(this,this.tick),1E3/this.ticksPerSecond),this._lastFrameTimestamp=this.timestamp();this._publish("game/start")},frame:function(){this.timestamp()-this._lastFrameTimestamp>1E3/this.ticksPerSecond&&
(console.log("tick!"),this.tick());requestAnimationFrame(this.frame)},tick:function(){this.timer.updateScheduledEvents();if(!this.isPaused){var a=(new Date).getTime();this.update();this.calendar.tick();this.ticks++;var b=(new Date).getTime();if(this.isLocalhost){this.totalUpdateTimeTicks++;a=b-a;this.totalUpdateTime[this.totalUpdateTimeCurrent]+=a;this.totalUpdateTimeCurrent=4==this.totalUpdateTimeCurrent?0:this.totalUpdateTimeCurrent+1;b=(this.totalUpdateTime[0]+this.totalUpdateTime[1]+this.totalUpdateTime[2]+
this.totalUpdateTime[3]+this.totalUpdateTime[4])/this.totalUpdateTimeTicks;var c=this.totalUpdateTime[0]/Math.floor((this.totalUpdateTimeTicks-1)/5),d=this.totalUpdateTime[1]/Math.floor((this.totalUpdateTimeTicks-2)/5),e=this.totalUpdateTime[2]/Math.floor((this.totalUpdateTimeTicks-3)/5),f=this.totalUpdateTime[3]/Math.floor((this.totalUpdateTimeTicks-4)/5),g=this.totalUpdateTime[4]/Math.floor((this.totalUpdateTimeTicks-5)/5);10>a&&(a=10);this.fps={ms:a,avg:b,avg0:c,avg1:d,avg2:e,avg3:f,avg4:g};0==
this.ticks%(60*this.ticksPerSecond)&&this.telemetry&&(a=null,window.performance&&window.performance.memory&&(a=performance.memory.usedJSHeapSize),this.telemetry.logEvent("fps",{ms:this.fps.ms,avg:this.fps.avg,memory:a}))}}},restartFPSCounters:function(){this.totalUpdateTime[0]=0;this.totalUpdateTime[1]=0;this.totalUpdateTime[2]=0;this.totalUpdateTime[3]=0;this.totalUpdateTimeCurrent=this.totalUpdateTime[4]=0;this.totalUpdateTimeTicks=5},reset:function(){var a=$I("reset.confirmation.title")+"\n\n"+
$I("reset.confirmation.msgbase");70<this.resPool.get("kittens").value?a+=" "+$I("reset.confirmation.msg70"):60<this.resPool.get("kittens").value?a+=" "+$I("reset.confirmation.msg60"):35>=this.resPool.get("kittens").value&&(a+=" "+$I("reset.confirmation.msg35"));var b=this;b.ui.confirm($I("reset.confirmation.title"),a,function(){b.opts.autoSaveReset&&b.saveToFile(!0);if(window.indexedDB){var c=indexedDB.open("kittens",1),d=b.compressLZData(localStorage["com.nuclearunicorn.kittengame.savedata"]),e;
c.onupgradeneeded=function(g){g=g.target.result;g.objectStoreNames.contains("save")||(g.createObjectStore("save",{autoIncrement:!0}).add(d),e=!0)};c.addEventListener("success",g=>{if(!e){var h=c.result;h.transaction(["save"],"readwrite").objectStore("save").clear().onsuccess=function(m){h.transaction(["save"],"readwrite").objectStore("save").add(d)}}})}b.challenges.onRunReset();b.challenges.isActive("atheism")&&0<b.time.getVSU("cryochambers").on&&(b.challenges.getChallenge("atheism").researched=!0,
b.ironWill&&b.achievements.unlockBadge("ivoryTower"));0>b.calendar.day&&b.achievements.unlockBadge("abOwo");for(var f=0;f<b.challenges.challenges.length;f++)b.challenges.challenges[f].pending=!1;b.resetAutomatic()})},resetAutomatic:function(){this.timer.scheduleEvent(dojo.hitch(this,function(){this._resetInternal();this.mobileSaveOnPause=!1;window.location.reload()}))},discardParagon:function(){var a=this,b=!1;this.ui.confirm("",$I("discardParagon.confirmation.msg1"),function(){100>=a.resPool.get("paragon").value?
b=!0:a.ui.confirm("",$I("discardParagon.confirmation.msg2"),function(){!a.ironWill||a.achievements.get("spaceOddity").starUnlocked?b=!0:a.ui.confirm("",$I("discardParagon.confirmation.msgIW"),function(){b=!0})})});b&&(this.resPool.get("burnedParagon").value+=this.resPool.get("paragon").value,this.resPool.get("paragon").value=0,this.ironWill&=this.achievements.get("spaceOddity").starUnlocked)},_getKarmaKittens:function(a){var b=0;this.challenges.getChallenge("anarchy").researched&&(a*=2);35<a&&(b+=
a-35);60<a&&(b+=3*(a-60));100<a&&(b+=4*(a-100));150<a&&(b+=5*(a-150));300<a&&(b+=10*(a-300));750<a&&(b+=15*(a-750));return b},_getBonusZebras:function(){var a=0,b=0,c=this.prestige.getPerk("anachronomancy");this.science.get("archery").researched&&10>this.karmaZebras&&(b=1);for(var d=0;d<this.science.techs.length;d++){var e=this.science.techs[d];if(("chronophysics"!=e.name||!c.researched)&&e.researched)for(var f in e.prices)if("science"==e.prices[f].name){a+=e.prices[f].val;break}}return b+=Math.floor(this.getLimitedDR(a/
1E4,100))},getResetPrestige:function(){var a=Math.round(this.resPool.get("kittens").value*(1+this.getEffect("simScalingRatio"))),b=this.karmaKittens;35<a&&(b+=this._getKarmaKittens(a));var c=0;70<a&&(c=a-70);return{karmaKittens:b,paragonPoints:c}},_resetInternal:function(){var a=this.getResetPrestige(),b=a.karmaKittens;a=a.paragonPoints;var c={paragon:a},d=parseInt(this.karmaZebras),e={totalParagon:a,totalResets:1};this.telemetry.logEvent("reset",this.stats.getStat("totalResets").val+1);a=[];for(var f=
0;f<this.stats.stats.length;f++){var g=this.stats.stats[f],h=g.val;0<e[g.name]&&(h+=e[g.name]);a.push({name:g.name,val:h})}e=[];for(f=0;f<this.stats.statsCurrent.length;f++)e.push({name:this.stats.statsCurrent[f].name,val:0});0<this.resPool.get("zebras").value&&this.ironWill&&(g=this._getBonusZebras(),d+=g);g=this.religion.faithRatio;this.religion.getRU("apocripha").on&&(g+=this.religion.getApocryphaResetBonus(1));this.save();(h=this._parseLSSaveData())||(h={game:{},stats:{},statsCurrent:{},achievements:{}});
var m=0<this.bld.get("chronosphere").val?this.getEffect("resStasisRatio"):0;dojo.mixin(h.game,{karmaKittens:b,karmaZebras:d,ironWill:0<m||0<this.time.getVSU("cryochambers").on?!1:!0,deadKittens:0,isCMBREnabled:!1});d=[];b=this.prestige.getPerk("anachronomancy");var n=this.workshop.get("fluxCondensator");for(f in this.resPool.resources){var k=this.resPool.resources[f];if(!1!==k.persists&&(!k.craftable||"wood"==k.name||n.researched)){var l=0;"timeCrystal"==k.name?b.researched&&(l=k.value):k.persists?
l=k.value:k.craftable&&"wood"!=k.name?0<k.value&&(l=Math.sqrt(k.value)*m*100):(l=k.value*m,"void"==k.name&&(l=Math.floor(l)));0<c[k.name]&&(l+=c[k.name]);0<l&&(k=this.resPool.createResource(k.name),k.value=l,d.push(k))}}c=[];l=this.time.getVSU("cryochambers").on;n=0;if(0<l){this.village.sim.sortKittensByExp();c=this.village.sim.kittens.slice(-l);for(f in c)delete c[f].job,delete c[f].engineerSpeciality;m=this.time.filterMetadata([this.time.getVSU("usedCryochambers")],["name","val","on"]);m[0].val=
l;m[0].on=l}else m=this.time.filterMetadata([this.time.getVSU("usedCryochambers")],["name","val","on"]),m[0].val=0,m[0].on=0;this.challenges.getChallenge("postApocalypse").pending&&(0<c.length&&((f=this.resPool.get("catnip"))||(f=this.resPool.createResource("catnip")),f.value=1E3*c.length*(1+this.resPool.get("karma").value/100),d.push(f)),n=1E8*(this.challenges.getChallenge("postApocalypse").on+c.length)+1E11);for(f=0;f<this.challenges.challenges.length;f++)l=this.challenges.challenges[f],l.pending?
(l.pending=!1,l.active=!0):l.active=!1;f=this.challenges.reserves.getSaveData();a={saveVersion:this.saveVersion,game:h.game,resources:d,buildings:[],calendar:{cryptoPrice:this.calendar.cryptoPrice},challenges:{challenges:this.challenges.challenges,reserves:f},diplomacy:{races:[]},prestige:{perks:this.prestige.perks},religion:{transcendenceTier:this.religion.transcendenceTier,faithRatio:g,activeHolyGenocide:this.religion.getTU("holyGenocide").on,zu:[],ru:[],tu:this.religion.filterMetadata(this.religion.transcendenceUpgrades,
["name","val","on","unlocked"])},science:{hideResearched:this.science.hideResearched,policyToggleResearched:this.science.policyToggleResearched,policyToggleBlocked:this.science.policyToggleBlocked,techs:[],policies:[]},space:{hideResearched:this.space.hideResearched,programs:[],planets:[]},time:{cfu:[{name:"temporalImpedance",unlocked:this.time.getCFU("temporalImpedance").unlocked}],vsu:[],usedCryochambers:m,timestamp:Date.now(),testShatter:this.time.testShatter},village:{kittens:c,jobs:[],traits:[],
hadKittenHunters:!1},workshop:{hideResearched:this.workshop.hideResearched,upgrades:[],crafts:[],zebraUpgrades:[]},achievements:h.achievements,ach:h.ach,stats:a,statsCurrent:e,telemetry:{guid:this.telemetry.guid},cathPollution:n};b.researched&&a.science.techs.push(this.science.get("chronophysics"));f=this._prepareSaveData(a);f=this._saveDataToString(f);LCstorage["com.nuclearunicorn.kittengame.savedata"]=f;this.isPaused=!0;return a},rand:function(a){return this.math.uniformRandomInteger(0,a)},updateKarma:function(){var a=
this.getUnlimitedDR(this.karmaKittens,5);this.resPool.get("karma").value=a;this.karmaZebras&&(this.resPool.get("zebras").maxValue=this.karmaZebras+1)},getUnlimitedDR:function(a,b){return(Math.sqrt(1+8*a/b)-1)/2},getInverseUnlimitedDR:function(a,b){return a*(a+1)*b/2},getTab:function(a){switch(a){case "science":return this.libraryTab;case "village":return this.villageTab;case "workshop":return this.workshopTab;case "space":return this.spaceTab;case "stats":return this.statsTab;case "time":return this.timeTab;
case "challenges":return this.challengesTab}},calculateAllEffects:function(){this.upgrade({tech:this.science.techs.map(function(a){return a.name}),policies:this.science.policies.map(function(a){return a.name}),perks:this.prestige.perks.map(function(a){return a.name}),jobs:this.village.jobs.map(function(a){return a.name}),crafts:this.workshop.crafts.map(function(a){return a.name}),upgrades:this.workshop.upgrades.map(function(a){return a.name}),buildings:this.bld.buildingsData.map(function(a){return a.name}),
spaceMission:this.space.programs.map(function(a){return a.name}),spaceBuilding:this.space.spaceBuildingsMap,planet:this.space.planets.map(function(a){return a.name}),chronoforge:this.time.chronoforgeUpgrades.map(function(a){return a.name}),voidSpace:this.time.voidspaceUpgrades.map(function(a){return a.name}),zigguratUpgrades:this.religion.zigguratUpgrades.map(function(a){return a.name}),religion:this.religion.religionUpgrades.map(function(a){return a.name}),transcendenceUpgrades:this.religion.transcendenceUpgrades.map(function(a){return a.name}),
pacts:this.religion.pactsManager.pacts.map(function(a){return a.name}),challenges:this.challenges.challenges.map(function(a){return a.name})})},getUnlockByName:function(a,b){switch(b){case "tech":return this.science.get(a);case "policies":return this.science.getPolicy(a);case "perks":return this.prestige.getPerk(a);case "jobs":return this.village.getJob(a);case "crafts":return this.workshop.getCraft(a);case "upgrades":return this.workshop.get(a);case "zebraUpgrades":return this.workshop.getZebraUpgrade(a);
case "tabs":return this.getTab(a);case "buildings":return this.bld.get(a);case "spaceMission":return this.space.getProgram(a);case "spaceBuilding":return this.space.getBuilding(a);case "planet":return this.space.getPlanet(a);case "chronoforge":return this.time.getCFU(a);case "voidSpace":return this.time.getVSU(a);case "stages":return this.bld.get(a.bld);case "zigguratUpgrades":return this.religion.getZU(a);case "religion":return this.religion.getRU(a);case "transcendenceUpgrades":return this.religion.getTU(a);
case "pacts":return this.religion.getPact(a);case "challenges":return this.challenges.getChallenge(a);case "schemes":return a;case "biomes":return this.village.getBiome(a)}},unlock:function(a){for(var b in a){if(0==a[b].length)break;for(var c=a[b].length-1;0<=c;c--){var d=a[b][c],e=this.getUnlockByName(d,b);e||(console.trace(),console.error("unable to evaluate locks for unlockId",d,"type",b));if(!e.evaluateLocks||e.evaluateLocks(this))"tabs"==b?e.visible=!0:"buildings"==b?e.unlockable=!0:"stages"==
b?e.stages[d.stage].stageUnlocked=!0:e?e.unlocked=!0:console.warn("unable to evaluate unlock '",d,"', skipping")}}},upgrade:function(a){this.updateCaches();for(var b in a){if(0==a[b].length)break;for(var c=a[b].length-1;0<=c;c--){var d=this.getUnlockByName(a[b][c],b);d?(d.calculateEffects&&(d.calculateEffects(d,this),"spaceBuilding"==b&&this.calendar.cycleEffectsBasics(d.effects,d.name)),d.unlockScheme&&d.val>=d.unlockScheme.threshold&&this.ui.unlockScheme(d.unlockScheme.name)):console.error("unable to get unlock by [id]",
a[b][c],"[type]",b)}}},toggleFilters:function(){var a=$("#logFilters");a.toggle();$("#filterIcon")[0].innerHTML=a.is(":visible")?"-":"+"},registerUndoChange:function(){var a=new classes.game.UndoChange;a.ttl=a._static.DEFAULT_TTL*this.ticksPerSecond;return this.undoChange=a},undo:function(){if(this.undoChange){var a={workshop:this.workshop,building:this.bld,religion:this.religion},b;for(b in this.undoChange.events){var c=this.undoChange.events[b],d=a[c.managerId];d&&d.undo&&d.undo(c.data)}this.undoChange=
null}},redeemGift:function(){if(0!=this.resPool.get("elderBox").value){var a="Karma";100<=this.resPool.get("paragon").value&&(a="Paragon");this.resPool.get("timeCrystal").value&&this.prestige.getPerk("anachronomancy").researched&&this.workshop.get("stasisChambers").researched&&(a="TimeCrystal");.25>this.resPool.get("sorrow").value/this.resPool.get("sorrow").maxValue&&this.prestige.getPerk("megalomania").researched&&3>this.religion.getZU("blackPyramid").val&&(a="BLS");this.religion.getRU("apocripha").on&&
(a="Apocrypha");this.religion.getRU("transcendence").on&&10>=this.religion.transcendenceTier&&(a="Transcendence");this.prestige.getPerk("engeneering").researched&&!this.prestige.getPerk("renaissance").researched&&(a="Metaphysics");this.bld.get("chronosphere").on&&(a="Compendiums");this.diplomacy.get("leviathans").energy==this.diplomacy.getMarkerCap()&&(a="BurnedParagon");var b=function(f){return f.charAt(0).toUpperCase()+f.slice(1)};switch(a){case "Karma":a=50<this.resPool.get("karma").value?25*Math.min(this.karmaKittens,
25E3):5E3;var c=this.getUnlimitedDR(this.karmaKittens+a,5)-this.getUnlimitedDR(this.karmaKittens,5);c=$I("gift.resources",[this.getDisplayValueExt(c),b($I("resources.karma.title"))]);this.karmaKittens+=a;break;case "Paragon":a=500<this.resPool.get("paragon").value?Math.min(this.resPool.get("paragon").value,1E3):100;c=$I("gift.resources",[this.getDisplayValueExt(a),b($I("resources.paragon.title"))]);this.resPool.addResEvent("paragon",a);break;case "TimeCrystal":a=100<this.resPool.get("timeCrystal").value?
Math.min(this.resPool.get("timeCrystal").value,2E3):50;c=$I("gift.resources",[this.getDisplayValueExt(a),b($I("resources.timeCrystal.title"))]);this.resPool.addResEvent("timeCrystal",a);break;case "BLS":a=this.resPool.get("sorrow").maxValue-this.resPool.get("sorrow").value;c=$I("gift.resources",[this.getDisplayValueExt(a),b($I("resources.sorrow.full"))]);this.resPool.addResEvent("sorrow",a);break;case "Apocrypha":a=10<this.religion.faithRatio?4*Math.min(this.religion.faithRatio,1E3):5;b=this.religion.getApocryphaBonus();
this.religion.faithRatio+=a;a=this.religion.getApocryphaBonus();c=$I("gift.apocrypha",[this.getDisplayValueExt(100*(a-b))]);break;case "Transcendence":this.religion.transcendenceTier+=4;c=$I("gift.transcendence");break;case "Metaphysics":if(this.prestige.getPerk("goldenRatio").researched)this.prestige.getPerk("divineProportion").researched?this.prestige.getPerk("vitruvianFeline").researched?this.prestige.getPerk("renaissance").researched||(this.prestige.getPerk("renaissance").researched=!0,d=$I("prestige.renaissance.label")):
(this.prestige.getPerk("vitruvianFeline").researched=!0,this.unlock(this.prestige.getPerk("vitruvianFeline").unlocks),d=$I("prestige.vitruvianFeline.label")):(this.prestige.getPerk("divineProportion").researched=!0,this.unlock(this.prestige.getPerk("divineProportion").unlocks),d=$I("prestige.divineProportion.label"));else{this.prestige.getPerk("goldenRatio").researched=!0;this.unlock(this.prestige.getPerk("goldenRatio").unlocks);var d=$I("prestige.goldenRatio.label")}c=$I("gift.metaphysics",[d]);
break;case "Compendiums":a=5E5<this.resPool.get("compedium").value?4*this.resPool.get("compedium").value:1E5;c=this.religion.getZU("unicornGraveyard");d=this.religion.getZU("unicornNecropolis");var e=function(f,g){var h=f.priceRatio,m=0,n=f.val,k;for(k in f.prices)f.prices[k].name==g&&(m=f.prices[k].val);return m*(Math.pow(h,n)-1)/(h-1)};d=Math.max(e(c,"necrocorn")+e(d,"necrocorn"),Math.max(this.resPool.get("necrocorn").value,10));c=$I("gift.resources",[this.getDisplayValueExt(a),b($I("resources.compedium.title"))]);
c+=$I("gift.resources",[this.getDisplayValueExt(d),b($I("resources.necrocorn.title"))]);this.resPool.addResEvent("compedium",a);this.resPool.addResEvent("necrocorn",d);break;case "BurnedParagon":a=500<this.resPool.get("burnedParagon").value?Math.min(this.resPool.get("burnedParagon").value,1500):150,c=$I("gift.resources",[this.getDisplayValueExt(a),b($I("resources.burnedParagon.title"))]),this.resPool.addResEvent("burnedParagon",a)}this.msg(c);this.resPool.addResEvent("elderBox",-1);this.resPool.addResEvent("wrappingPaper",
1)}},unlockAll:function(){for(var a in this.tabs)this.tabs[a].visible=!0;this.resPool.get("paragon").value=1},isEldermass:function(){return!1},createRandomName:function(a,b){b||="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25a0\u25c6\u25c6\u00e5\u0153\u2211\u00df\u2248\u00e7\u2202\u00b4\u00ae\u0192\u221a\u222b\u00a9\u2020\u00a5\u02d9\u02dc\u00b5\u2206\u00a8\u02c6\u02da\u00b5\u2264\u00ac\u00f8\u03c0\u2265\u2026\u03c0\u201c\u00e6\u00f7\u00e6\u00ab\u00a7\u00a1\u2122\u00a3\u00a2\u221e\u00a7\u00b6\u2022\u00aa\u00ba\u2260";
var c=Math.floor(6*Math.random()+5);a&&(c=a-1);a="";for(var d=0;d<=c;d++)a+=b[Math.floor(Math.random()*b.length)];return a},createRandomVarietyAndColor:function(a,b){function c(f){return Math.floor(Math.random()*f)}null==a&&(a=10);null==b&&(b=10);var d=0,e=0;c(100)<=a&&(d=c(6)+1,c(100)<=b&&(e=c(4)+1));return[d,e]}});
