dojo.declare("classes.Metadata",null,{meta:null,constructor:function(a){if(!a)throw"Building metadata must be provided for classes.Building instance";this.meta=a},getMeta:function(){return this.meta},get:function(a){return this.meta[a]},set:function(a,b){this.meta[a]=b}});
dojo.declare("classes.BuildingMeta",classes.Metadata,{_metaCache:null,_metaCacheStage:null,getMeta:function(){var a=this.meta;a.stage!==this._metaCacheStage&&(this._metaCache=null);if(this._metaCache)return this._metaCache;if(a.stages){a.stage>=a.stages.length&&(a.stage=a.stages.length-1);var b=a.stages[a.stage||0],c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);this._metaCache=c}else this._metaCache=a;this._metaCacheStage=a.stage;return this._metaCache},
get:function(a){var b=this.meta;b.stage!==this._metaCacheStage&&(this._metaCache=null);if(this._metaCache)return this._metaCache[a];if(b.stages){b.stage>=b.stages.length&&(b.stage=b.stages.length-1);var c=b.stages[b.stage||0];if(c.hasOwnProperty(a))return c[a]}return b[a]},set:function(a,b){var c=this.meta;if(c.stages&&(c=c.stages[c.stage||0],void 0!=c[a])){c[a]=b;return}this.meta[a]=b;this._metaCache&&("stage"===a?this._metaCache=null:this._metaCache[a]=b)}});
dojo.declare("classes.managers.BuildingsManager",com.nuclearunicorn.core.TabManager,{game:null,metaCache:null,groupBuildings:!1,twoRows:!1,cathPollution:0,cathPollutionPerTick:0,constructor:function(a){this.game=a;this.metaCache={};this.registerMeta(!1,this.buildingsData,{getEffect:function(b,c){if(b.stages){b.stage>=b.stages.length&&(b.stage=b.stages.length-1);var d=b.stages[b.stage||0];d=d.effects?d.effects[c]:b.effects[c]}else d=b.effects[c];b="coalRatioGlobal"==c?d:-1!=c.indexOf("Max",c.length-
3)&&"library"!=b.name||"biolab"==b.name&&-1!=c.indexOf("Ratio",c.length-5)?d*b.val:d*b.on;("productionRatio"==c||"magnetoRatio"==c)&&a.resPool.energyCons>a.resPool.energyProd&&(b*=a.resPool.getEnergyDelta());return b}});this.setEffectsCachedExisting()},setEffectsCachedExisting:function(){this.inherited(arguments);for(var a=0;a<this.buildingsData.length;a++){var b=this.buildingsData[a];if(b.stages)for(var c=0;c<b.stages.length;c++)for(var d in b.stages[c].effects)this.effectsCachedExisting[d]=0}},
buildingGroups:[{name:"food",title:$I("buildings.group.food"),buildings:["field","pasture","aqueduct"]},{name:"population",title:$I("buildings.group.population"),buildings:["hut","logHouse","mansion"]},{name:"science",title:$I("buildings.group.science"),buildings:["library","academy","observatory","biolab"]},{name:"storage",title:$I("buildings.group.storage"),buildings:["barn","warehouse","harbor"]},{name:"resource",title:$I("buildings.group.resource"),buildings:["mine","quarry","lumberMill","oilWell",
"accelerator"]},{name:"industry",title:$I("buildings.group.industry"),buildings:"steamworks magneto smelter calciner factory reactor".split(" ")},{name:"culture",title:$I("buildings.group.culture"),buildings:["amphitheatre","chapel","temple"]},{name:"other",title:$I("buildings.group.other"),buildings:["workshop","tradepost","mint","unicornPasture","brewery"]},{name:"megastructures",title:$I("buildings.group.megastructures"),buildings:["ziggurat","chronosphere","aiCore"]},{name:"zebraBuildings",title:$I("buildings.group.zebraBuildings"),
buildings:["zebraOutpost","zebraWorkshop","zebraForge","ivoryTemple"]}],buildingsData:[{name:"field",label:$I("buildings.field.label"),description:$I("buildings.field.desc"),unlockRatio:.3,defaultUnlockable:!0,prices:[{name:"catnip",val:10}],priceRatio:1.12,effects:{catnipPerTickBase:.125},flavor:$I("buildings.field.flavor"),unlockScheme:{name:"catnip",threshold:56}},{name:"pasture",unlockRatio:.3,stages:[{label:$I("buildings.pasture.label"),description:$I("buildings.pasture.desc"),prices:[{name:"catnip",
val:100},{name:"wood",val:10}],priceRatio:1.15,effects:{catnipDemandRatio:-.005},flavor:$I("buildings.pasture.flavor"),stageUnlocked:!0},{label:$I("buildings.solarfarm.label"),description:$I("buildings.solarfarm.desc"),prices:[{name:"titanium",val:250}],priceRatio:1.15,calculateEffects:function(a,b){a.effects={energyProduction:a.calculateEnergyProduction(b,b.calendar.season)}},calculateEnergyProduction:function(a,b){a.challenges.isActive("winterIsComing")&&(b=3);var c=2*(1+a.getEffect("solarFarmRatio"));
3==b?c*=.75:1==b&&(c=c/.75*(1+a.getLimitedDR(a.getEffect("summerSolarFarmRatio"),2)));a=a.getEffect("solarFarmSeasonRatio");if(3==b&&1==a||1!=b&&2==a)c*=1+.15*a;return c},stageUnlocked:!1}],effects:{},calculateEffects:function(a,b){a=a.stages[a.stage];a.calculateEffects&&a.calculateEffects(a,b)}},{name:"aqueduct",unlockRatio:.3,stages:[{label:$I("buildings.aqueduct.label"),description:$I("buildings.aqueduct.desc"),prices:[{name:"minerals",val:75}],priceRatio:1.12,effects:{catnipRatio:.03},flavor:$I("buildings.aqueduct.flavor"),
stageUnlocked:!0},{label:$I("buildings.hydroplant.label"),description:$I("buildings.hydroplant.desc"),prices:[{name:"titanium",val:2500},{name:"concrate",val:100}],priceRatio:1.15,effects:{energyProduction:5},stageUnlocked:!1}],effects:{catnipRatio:0,energyProduction:0},calculateEffects:function(a,b){var c=a.stages[a.stage];0!=a.stage&&1==a.stage&&(a={energyProduction:5},a.energyProduction*=1+b.getEffect("hydroPlantRatio"),c.effects=a)}},{name:"hut",label:$I("buildings.hut.label"),description:$I("buildings.hut.desc"),
unlockRatio:.3,prices:[{name:"wood",val:5}],priceRatio:2.5,defaultUnlockable:!0,unlocks:{tabs:["village"]},upgrades:{policies:["authocracy"]},effects:{manpowerMax:75,maxKittens:2},breakIronWill:!0,almostLimited:!1,flavor:$I("buildings.hut.flavor")},{name:"logHouse",label:$I("buildings.logHouse.label"),description:$I("buildings.logHouse.desc"),unlockRatio:.3,prices:[{name:"wood",val:200},{name:"minerals",val:250}],priceRatio:1.15,effects:{manpowerMax:50,maxKittens:1},unlocks:{tabs:["village"]},upgrades:{policies:["authocracy"]},
breakIronWill:!0,almostLimited:!1,flavor:$I("buildings.logHouse.flavor")},{name:"mansion",label:$I("buildings.mansion.label"),description:$I("buildings.mansion.desc"),prices:[{name:"titanium",val:25},{name:"slab",val:185},{name:"steel",val:75}],priceRatio:1.15,effects:{manpowerMax:50,maxKittens:1},unlocks:{tabs:["village"]},upgrades:{policies:["authocracy"]},breakIronWill:!0,almostLimited:!1,flavor:$I("buildings.mansion.flavor")},{name:"library",stages:[{label:$I("buildings.library.label"),description:$I("buildings.library.desc"),
unlockRatio:.3,prices:[{name:"wood",val:25}],effects:{scienceRatio:0,scienceMax:0,cultureMax:0},stageUnlocked:!0,flavor:$I("buildings.library.flavor")},{label:$I("buildings.dataCenter.label"),description:$I("buildings.dataCenter.desc"),prices:[{name:"steel",val:100},{name:"concrate",val:10}],effects:{scienceMaxCompendia:1E3,cultureMax:25,energyConsumption:2},unlockScheme:{name:"computer",threshold:100},stageUnlocked:!1}],priceRatio:1.15,defaultUnlockable:!0,unlocks:{tabs:["science"],jobs:["scholar"]},
upgrades:{buildings:["biolab","observatory"]},calculateEffects:function(a,b){var c=a.stages[a.stage],d={scienceRatio:.1,scienceMax:250,cultureMax:10},e=b.getEffect("libraryRatio");d.scienceMax*=1+b.bld.get("observatory").on*e;1==a.stage&&(d.scienceMaxCompendia=1E3,d.scienceMax*=3,d.cultureMax=250,e=b.bld.get("biolab").val*b.getEffect("uplinkDCRatio"),b.workshop.get("uplink").researched&&(d.scienceMaxCompendia*=1+e,d.scienceMax*=1+e,d.cultureMax*=1+e),d.energyConsumption=2,b.workshop.get("cryocomputing").researched&&
(d.energyConsumption=1),b.workshop.get("machineLearning").researched&&(e=b.getEffect("dataCenterAIRatio"),e*=1+b.getEffect("aiCoreUpgradeBonus")||0,d.scienceMaxCompendia*=1+b.bld.get("aiCore").on*e,d.scienceMax*=1+b.bld.get("aiCore").on*e,d.cultureMax*=1+b.bld.get("aiCore").on*e));c.effects=d;a.val&&(b.time.queue.unlockQueueSource("tech"),b.time.queue.unlockQueueSource("policies"))}},{name:"academy",label:$I("buildings.academy.label"),description:$I("buildings.academy.desc"),unlockRatio:.3,prices:[{name:"wood",
val:50},{name:"minerals",val:70},{name:"science",val:100}],priceRatio:1.15,effects:{scienceRatio:.2,skillXP:5E-4,scienceMax:500,cultureMax:25,academyMeteorBonus:0},calculateEffects:function(a,b){b.workshop.getZebraUpgrade("minerologyDepartment").researched?a.effects.academyMeteorBonus=.01:a.effects.academyMeteorBonus=0},flavor:$I("buildings.academy.flavor"),unlockScheme:{name:"school",threshold:68}},{name:"observatory",label:$I("buildings.observatory.label"),description:$I("buildings.observatory.desc"),
prices:[{name:"iron",val:750},{name:"science",val:1E3},{name:"slab",val:35},{name:"scaffold",val:50}],priceRatio:1.1,upgrades:{buildings:["library"]},effects:{starEventChance:.002,starAutoSuccessChance:.01},calculateEffects:function(a,b){var c=1+b.getEffect("observatoryRatio");a.effects.scienceRatio=.25*c;a.effects.scienceMax=c*(b.workshop.get("astrolabe").researched?1500:1E3)},flavor:$I("buildings.observatory.flavor")},{name:"biolab",label:$I("buildings.biolab.label"),description:$I("buildings.biolab.desc"),
prices:[{name:"science",val:1500},{name:"slab",val:100},{name:"alloy",val:25}],priceRatio:1.1,effects:{scienceRatio:.35,refineRatio:.1,scienceMax:0,catnipPerTickCon:0,oilPerTickProd:0,energyConsumption:0},upgrades:{buildings:["library"]},effectsCalculated:{},calculateEffects:function(a,b){b.workshop.get("biofuel").researched?(a.togglable=!0,a.effects.catnipPerTickCon=-1,a.effects.oilPerTickProd=.02*(1+b.getEffect("biofuelRatio")),a.effects.energyConsumption=1):(a.togglable=!1,a.effects.catnipPerTickCon=
0,a.effects.oilPerTickProd=0,a.effects.energyConsumption=0);a.effects.scienceMax=1500;b.workshop.get("uplink").researched&&1==b.bld.get("library").stage&&(b=b.bld.get("library").val*b.getEffect("uplinkLabRatio"),a.effects.scienceMax*=1+b);for(var c in a.effects)a.effectsCalculated[c]=a.effects[c]},lackResConvert:!1,action:function(a,b){if(b.workshop.get("biofuel").researched){b=b.resPool.getAmtDependsOnStock([{res:"catnip",amt:-a.effectsCalculated.catnipPerTickCon}],a.on);for(var c in a.effects)if("catnipPerTickCon"==
c||"oilPerTickProd"==c)a.effects[c]=a.effectsCalculated[c]*b;a.val&&(a.effects.scienceRatio=.35*(1+a.on/a.val));return b}},flavor:$I("buildings.biolab.flavor")},{name:"barn",label:$I("buildings.barn.label"),description:$I("buildings.barn.desc"),unlockRatio:.3,prices:[{name:"wood",val:50}],priceRatio:1.75,effects:{catnipMax:0,woodMax:0,mineralsMax:0,coalMax:0,ironMax:0,titaniumMax:0,goldMax:0},calculateEffects:function(a,b){a.effects=b.resPool.addBarnWarehouseRatio({catnipMax:5E3,woodMax:200,mineralsMax:250,
coalMax:60,ironMax:50,titaniumMax:2,goldMax:10})},flavor:$I("buildings.barn.flavor")},{name:"warehouse",label:$I("buildings.warehouse.label"),description:$I("buildings.warehouse.desc"),prices:[{name:"beam",val:1.5},{name:"slab",val:2}],priceRatio:1.15,effects:{catnipMax:0,woodMax:0,mineralsMax:0,coalMax:0,ironMax:0,titaniumMax:0,goldMax:0},calculateEffects:function(a,b){var c={catnipMax:0,woodMax:150,mineralsMax:200,coalMax:30,ironMax:25,titaniumMax:10,goldMax:5};b.workshop.get("silos").researched&&
(c.catnipMax=750);a.effects=b.resPool.addBarnWarehouseRatio(c)},flavor:$I("buildings.warehouse.flavor"),unlockScheme:{name:"minimalist",threshold:10}},{name:"harbor",label:$I("buildings.harbor.label"),description:$I("buildings.harbor.desc"),prices:[{name:"slab",val:50},{name:"plate",val:75},{name:"scaffold",val:5}],priceRatio:1.15,effects:{catnipMax:0,woodMax:0,mineralsMax:0,coalMax:0,ironMax:0,titaniumMax:0,goldMax:0},calculateEffects:function(a,b){var c={catnipMax:2500,woodMax:700,mineralsMax:950,
coalMax:100,ironMax:150,titaniumMax:50,goldMax:25};c.coalMax*=1+b.getEffect("harborCoalRatio");var d=b.workshop.get("cargoShips");if(d.researched){var e=b.resPool.get("ship").value,g=2.25+b.getEffect("shipLimit")*b.bld.get("reactor").on;d=1+b.getLimitedDR(d.effects.harborRatio*e,g);c.catnipMax*=d;c.woodMax*=d;c.mineralsMax*=d;c.coalMax*=d;c.ironMax*=d;c.titaniumMax*=d;c.goldMax*=d}a.effects=b.resPool.addBarnWarehouseRatio(c)},flavor:$I("buildings.harbor.flavor")},{name:"mine",label:$I("buildings.mine.label"),
description:$I("buildings.mine.desc"),unlockRatio:.15,prices:[{name:"wood",val:100}],priceRatio:1.15,unlocks:{jobs:["miner"]},effects:{mineralsRatio:0,coalPerTickBase:0,cathPollutionPerTickProd:0},calculateEffects:function(a,b){var c={mineralsRatio:.2,coalPerTickBase:0,cathPollutionPerTickProd:.08};b.workshop.get("deepMining").researched&&(c.coalPerTickBase=.003);a.effects=c;a.togglable=b.science.get("ecology").researched},flavor:$I("buildings.mine.flavor"),unlockScheme:{name:"anthracite",threshold:92}},
{name:"quarry",label:$I("buildings.quarry.label"),description:$I("buildings.quarry.desc"),unlockRatio:.3,prices:[{name:"slab",val:1E3},{name:"steel",val:125},{name:"scaffold",val:50}],priceRatio:1.15,effects:{mineralsRatio:.35,coalPerTickBase:.015,uraniumPerTickBase:0,cathPollutionPerTickProd:.25},calculateEffects:function(a,b){var c={mineralsRatio:.35,coalPerTickBase:.015,uraniumPerTickBase:0,cathPollutionPerTickProd:.25};b.workshop.get("orbitalGeodesy").researched&&(c.uraniumPerTickBase=5E-4);a.effects=
c;a.togglable=b.science.get("ecology").researched},flavor:$I("buildings.quarry.flavor")},{name:"smelter",label:$I("buildings.smelter.label"),description:$I("buildings.smelter.desc"),unlockRatio:.3,prices:[{name:"minerals",val:200}],priceRatio:1.15,effects:{woodPerTickCon:0,mineralsPerTickCon:0,coalPerTickAutoprod:0,ironPerTickAutoprod:0,titaniumPerTickAutoprod:0,goldPerTickAutoprod:0,cathPollutionPerTickProd:.15},effectsCalculated:{},lackResConvert:!1,calculateEffects:function(a,b){var c=1+b.getEffect("smelterRatio");
a.effects.ironPerTickAutoprod=.02*c;b.workshop.get("goldOre").researched?a.effects.goldPerTickAutoprod=.001:a.effects.goldPerTickAutoprod=0;b.workshop.get("coalFurnace").researched?a.effects.coalPerTickAutoprod=.005*c:a.effects.coalPerTickAutoprod=0;b.workshop.get("nuclearSmelters").researched?a.effects.titaniumPerTickAutoprod=.0015:a.effects.titaniumPerTickAutoprod=0;a.effects.woodPerTickCon=-.05;a.effects.mineralsPerTickCon=-.1;for(var d in a.effects)a.effectsCalculated[d]=a.effects[d]},action:function(a,
b){if(!(1>a.on)){var c=b.resPool.get("iron");if(b.ironWill&&b.opts.IWSmelter&&c.value>.95*c.maxValue)a.on=0;else{b=b.resPool.getAmtDependsOnStock([{res:"wood",amt:-a.effectsCalculated.woodPerTickCon},{res:"minerals",amt:-a.effectsCalculated.mineralsPerTickCon}],a.on);for(var d in a.effects)if("woodPerTickCon"==d||"mineralsPerTickCon"==d||"coalPerTickAutoprod"==d||"ironPerTickAutoprod"==d||"titaniumPerTickAutoprod"==d||"goldPerTickAutoprod"==d)a.effects[d]=a.effectsCalculated[d]*b;return b}}},flavor:$I("buildings.smelter.flavor")},
{name:"calciner",label:$I("buildings.calciner.label"),description:$I("buildings.calciner.desc"),prices:[{name:"titanium",val:15},{name:"oil",val:500},{name:"steel",val:100},{name:"blueprint",val:1}],priceRatio:1.15,effects:{mineralsPerTickCon:-1.5,coalPerTickCon:0,ironPerTickCon:0,ironPerTickAutoprod:.15,titaniumPerTickAutoprod:5E-4,oilPerTickCon:-.024,steelPerTickProd:0,energyConsumption:1,cathPollutionPerTickProd:1},calculateEffects:function(a,b){a.basicProductionCalculation(a,b);a.steelProductionCalculation(a,
b)},effectsCalculated:{},basicProductionCalculation:function(a,b){a.effects.mineralsPerTickCon=-1.5;a.effects.oilPerTickCon=-.024;b=b.getEffect("calcinerRatio");a.effects.ironPerTickAutoprod=.15*(1+b);a.effects.titaniumPerTickAutoprod=5E-4*(1+3*b);a.effectsCalculated.mineralsPerTickCon=a.effects.mineralsPerTickCon;a.effectsCalculated.oilPerTickCon=a.effects.oilPerTickCon;a.effectsCalculated.ironPerTickAutoprod=a.effects.ironPerTickAutoprod;a.effectsCalculated.titaniumPerTickAutoprod=a.effects.titaniumPerTickAutoprod},
isAutomationEnabled:null,steelProductionCalculation:function(a,b,c){a.effects.coalPerTickCon=0;a.effects.ironPerTickCon=0;a.effects.steelPerTickProd=0;var d=b.getEffect("calcinerSteelRatio");if(0!=d&&(null==a.isAutomationEnabled&&(a.isAutomationEnabled=!0),a.isAutomationEnabled)){d=a.effects.ironPerTickAutoprod*d*b.bld.getAutoProductionRatio();var e={};e.iron=d;b.calendar.cycleEffectsFestival(e);d=e.iron;d*=1+b.resPool.get("sorrow").value*b.getEffect("blsProductionBonus");d*=1+b.getEffect("ironPolicyRatio");
a.effects.coalPerTickCon=-d;a.effects.ironPerTickCon=-d;a.effects.steelPerTickProd=d/100;if(c)return c=b.resPool.getAmtDependsOnStock([{res:"coal",amt:-a.effects.coalPerTickCon},{res:"iron",amt:-a.effects.ironPerTickCon}],a.on),a.effects.coalPerTickCon*=c,a.effects.ironPerTickCon*=c,a.effects.steelPerTickProd=a.effects.steelPerTickProd*c*(1+b.getCraftRatio()*b.getEffect("calcinerSteelCraftRatio")+b.bld.get("reactor").on*b.getEffect("calcinerSteelReactorBonus")),c;a.effects.steelPerTickProd*=1+b.getCraftRatio()*
b.getEffect("calcinerSteelCraftRatio")+b.bld.get("reactor").on*b.getEffect("calcinerSteelReactorBonus")}return-1},lackResConvert:!1,action:function(a,b){if(!(1>a.on)){var c=b.resPool.getAmtDependsOnStock([{res:"minerals",amt:-a.effectsCalculated.mineralsPerTickCon},{res:"oil",amt:-a.effectsCalculated.oilPerTickCon}],a.on);a.effects.mineralsPerTickCon=a.effectsCalculated.mineralsPerTickCon*c;a.effects.oilPerTickCon=a.effectsCalculated.oilPerTickCon*c;a.effects.ironPerTickAutoprod=a.effectsCalculated.ironPerTickAutoprod*
c;a.effects.titaniumPerTickAutoprod=a.effectsCalculated.titaniumPerTickAutoprod*c;var d=c;c=a.steelProductionCalculation(a,b,!0);-1<c&&(d=(c+d)/2);return d}}},{name:"steamworks",label:$I("buildings.steamworks.label"),description:$I("buildings.steamworks.desc"),prices:[{name:"steel",val:65},{name:"gear",val:20},{name:"blueprint",val:1}],priceRatio:1.25,effects:{coalRatioGlobal:0,manuscriptPerTickProd:0,energyProduction:1,magnetoBoostRatio:.15,cathPollutionPerTickProd:1},calculateEffects:function(a,
b){a.effects.coalRatioGlobal=-.8+b.getEffect("coalRatioGlobalReduction");var c=0;b.workshop.get("printingPress").researched&&(c=5E-4,b.workshop.get("offsetPress").researched&&(c*=4),b.workshop.get("photolithography").researched&&(c*=4));a.effects.manuscriptPerTickProd=c},jammed:!1,togglableOnOff:!0,isAutomationEnabled:null,action:function(a,b){if(!(1>a.on||a.jammed)&&b.workshop.get("factoryAutomation").researched){null==a.isAutomationEnabled&&(a.isAutomationEnabled=!0);var c=b.resPool.get("wood"),
d=b.resPool.get("minerals"),e=b.resPool.get("iron");if(0!=c.maxValue&&0!=d.maxValue){var g=Math.min(.02*(a.on+1),.9),f=function(h,l,m){var k=h.value*g;return{numberOfCrafts:m&&h.value>=.98*h.maxValue?Math.max(0,Math.floor(k/b.workshop.getCraft(l).prices[0].val)):0,craft:function(){0<this.numberOfCrafts&&(b.workshop.craft(l,this.numberOfCrafts),b.msg($I("bld.msg.automation."+l+"s",[b.getDisplayValueExt(k),b.getDisplayValueExt(this.numberOfCrafts*(1+b.getCraftRatio()))]),null,"workshopAutomation",!0))}}};
c=f(c,"beam",!0);d=f(d,"slab",!0);e=f(e,"plate",b.workshop.get("pneumaticPress").researched);if(0!=c.numberOfCrafts||0!=d.numberOfCrafts||0!=e.numberOfCrafts)a.jammed=!0,a.isAutomationEnabled?(c.craft(),d.craft(),e.craft(),b.msg($I("bld.msg.automation"),null,"workshopAutomation")):b.msg($I("bld.msg.automation.skip"),null,"workshopAutomation")}}},flavor:$I("buildings.steamworks.flavor")},{name:"magneto",label:$I("buildings.magneto.label"),description:$I("buildings.magneto.desc"),prices:[{name:"gear",
val:5},{name:"alloy",val:10},{name:"blueprint",val:1}],priceRatio:1.25,effects:{oilPerTick:-.05,energyProduction:5,magnetoRatio:.02,cathPollutionPerTickProd:5},action:function(a,b){0>=b.resPool.get("oil").value+a.effects.oilPerTick&&a.on--}},{name:"lumberMill",label:$I("buildings.lumberMill.label"),description:$I("buildings.lumberMill.desc"),unlockRatio:.3,prices:[{name:"wood",val:100},{name:"minerals",val:250},{name:"iron",val:50}],priceRatio:1.15,effects:{woodRatio:0},calculateEffects:function(a,
b){a.effects.woodRatio=.1+.1*b.getEffect("lumberMillRatio")},flavor:$I("buildings.lumberMill.flavor")},{name:"oilWell",label:$I("buildings.oilWell.label"),description:$I("buildings.oilWell.desc"),prices:[{name:"steel",val:50},{name:"gear",val:25},{name:"scaffold",val:25}],priceRatio:1.15,effects:{oilPerTickBase:.02,oilMax:1500,energyConsumption:0,cathPollutionPerTickProd:0},isAutomationEnabled:null,calculateEffects:function(a,b){var c=b.workshop.get("pumpjack").researched;a.togglable=c;null==a.isAutomationEnabled&&
c&&(a.isAutomationEnabled=!0);c=1+b.getEffect("oilWellRatio");0==a.isAutomationEnabled&&(c-=b.workshop.get("pumpjack").effects.oilWellRatio);a.effects.oilPerTickBase=.02*c;a.effects.energyConsumption=a.isAutomationEnabled?1:0;a.effects.cathPollutionPerTickProd=a.isAutomationEnabled?1:0},flavor:$I("buildings.oilWell.flavor"),unlockScheme:{name:"oil",threshold:73}},{name:"workshop",label:$I("buildings.workshop.label"),description:$I("buildings.workshop.desc"),defaultUnlockable:!0,unlockRatio:.0025,
prices:[{name:"wood",val:100},{name:"minerals",val:400}],priceRatio:1.15,unlocks:{tabs:["workshop"]},effects:{craftRatio:.06},calculateEffects:function(a,b){a.val&&b.time.queue.unlockQueueSource("upgrades")},flavor:$I("buildings.workshop.flavor")},{name:"factory",label:$I("buildings.factory.label"),description:$I("buildings.factory.desc"),prices:[{name:"titanium",val:2E3},{name:"plate",val:2500},{name:"concrate",val:15}],isAutomationEnabled:null,priceRatio:1.15,effects:{craftRatio:0,energyConsumption:0,
cathPollutionPerTickProd:0,cathPollutionPerTickCon:0},unlocks:{policies:["liberalism","communism","fascism"]},unlockScheme:{name:"factory",threshold:20},calculateEffects:function(a,b){var c={craftRatio:.05*(1+b.getEffect("environmentFactoryCraftBonus"))};b.workshop.get("factoryLogistics").researched&&(c.craftRatio=.06*(1+b.getEffect("environmentFactoryCraftBonus")));c.energyConsumption=2;b.workshop.get("carbonSequestration").researched?a.isAutomationEnabled=null===a.isAutomationEnabled?!0:a.isAutomationEnabled:
a.isAutomationEnabled=null;c.energyConsumption*=a.isAutomationEnabled?2:1;c.cathPollutionPerTickProd=a.isAutomationEnabled?0:b.workshop.get("carbonSequestration").researched?1:2;c.cathPollutionPerTickCon=a.isAutomationEnabled?-2:0;a.effects=c}},{name:"reactor",label:$I("buildings.reactor.label"),description:$I("buildings.reactor.desc"),prices:[{name:"titanium",val:3500},{name:"plate",val:5E3},{name:"concrate",val:50},{name:"blueprint",val:25}],priceRatio:1.15,upgrades:{buildings:["harbor"]},effects:{uraniumPerTick:-.001,
thoriumPerTick:0,productionRatio:.05,uraniumMax:250,energyProduction:10},isAutomationEnabled:null,calculateEffects:function(a,b){a.effects.uraniumPerTick=-.001*(1-b.getEffect("uraniumRatio"));null==a.isAutomationEnabled&&b.workshop.get("thoriumReactors").researched&&(a.isAutomationEnabled=!0)},action:function(a,b){0>=b.resPool.get("uranium").value+a.effects.uraniumPerTick&&(a.on=0);var c=0==a.isAutomationEnabled||a.isAutomationEnabled&&0>=b.resPool.get("thorium").value;a.effects.thoriumPerTick=c?
0:b.getEffect("reactorThoriumPerTick");var d=1+b.getEffect("reactorEnergyRatio");c&&(d-=b.workshop.get("thoriumReactors").effects.reactorEnergyRatio,a.isAutomationEnabled=!1);a.effects.energyProduction=10*d},flavor:$I("buildings.reactor.flavor")},{name:"accelerator",label:$I("buildings.accelerator.label"),description:$I("buildings.accelerator.desc"),prices:[{name:"titanium",val:7500},{name:"uranium",val:25},{name:"concrate",val:125}],priceRatio:1.15,effects:{titaniumPerTickCon:-.015,uraniumPerTickAutoprod:.0025,
catnipMax:0,woodMax:0,mineralsMax:0,coalMax:0,ironMax:0,titaniumMax:0,goldMax:0,scienceMax:0,energyConsumption:0},calculateEffects:function(a,b){a.effects.energyConsumption=2;a.effects.scienceMax=0;b.workshop.get("lhc").researched&&(a.effects.scienceMax=2500);var c=0;b.workshop.get("energyRifts").researched&&(c=1+b.getEffect("acceleratorRatio"));a.effects.catnipMax=3E4*c;a.effects.woodMax=2E4*c;a.effects.mineralsMax=25E3*c;a.effects.coalMax=2500*c;a.effects.ironMax=7500*c;a.effects.titaniumMax=750*
c;a.effects.goldMax=250*c},lackResConvert:!1,action:function(a,b){a.effects.titaniumPerTickCon=-.015;a.effects.uraniumPerTickAutoprod=.0025;b=b.resPool.getAmtDependsOnStock([{res:"titanium",amt:-a.effects.titaniumPerTickCon}],a.on);a.effects.titaniumPerTickCon*=b;a.effects.uraniumPerTickAutoprod*=b;return b},flavor:$I("buildings.accelerator.flavor")},{name:"tradepost",label:$I("buildings.tradepost.label"),description:$I("buildings.tradepost.desc"),unlockRatio:.3,prices:[{name:"wood",val:500},{name:"minerals",
val:200},{name:"gold",val:10}],priceRatio:1.15,effects:{fursDemandRatio:-.04,ivoryDemandRatio:-.04,spiceDemandRatio:-.04,tradeRatio:.015,standingRatio:0},calculateEffects:function(a,b){a.effects.standingRatio=b.workshop.get("caravanserai").researched?.0035:0},upgrades:{challenges:["pacifism"]},flavor:$I("buildings.tradepost.flavor")},{name:"mint",label:$I("buildings.mint.label"),description:$I("buildings.mint.desc"),prices:[{name:"minerals",val:5E3},{name:"gold",val:500},{name:"plate",val:200}],priceRatio:1.15,
effects:{goldPerTickCon:-.005,manpowerPerTickCon:-.75,fursPerTickProd:.00875,ivoryPerTickProd:.0021,goldMax:100},calculateEffects:function(a,b){a.effects.goldMax=100*(1+b.getEffect("warehouseRatio"))},lackResConvert:!1,action:function(a,b){if(!(1>a.on)){a.effects.goldPerTickCon=-.005;a.effects.manpowerPerTickCon=-.75;var c=.007*b.resPool.get("manpower").maxValue/100;c*=1+.005*b.village.map.villageLevel;c*=1+b.getEffect("mintRatio");a.effects.fursPerTickProd=1.25*c;a.effects.ivoryPerTickProd=.3*c;
b=b.resPool.getAmtDependsOnStock([{res:"gold",amt:-a.effects.goldPerTickCon},{res:"manpower",amt:-a.effects.manpowerPerTickCon}],a.on);a.effects.goldPerTickCon*=b;a.effects.manpowerPerTickCon*=b;a.effects.fursPerTickProd*=b;a.effects.ivoryPerTickProd*=b;return b}},unlockScheme:{name:"gold",threshold:24}},{name:"brewery",label:$I("buildings.brewery.label"),description:$I("buildings.brewery.desc"),unlockRatio:.2,prices:[{name:"wood",val:1E3},{name:"culture",val:750},{name:"spice",val:5},{name:"parchment",
val:375}],priceRatio:1.5,effects:{catnipPerTickCon:-1,spicePerTickCon:-.1,festivalRatio:.01,festivalArrivalRatio:.001},effectsCalculated:{},togglable:!0,lackResConvert:!1,calculateEffects:function(a,b){a.effects={catnipPerTickCon:-1*(1+b.getEffect("breweryConsumptionRatio")),spicePerTickCon:-.1*(1+b.getEffect("breweryConsumptionRatio")),festivalRatio:.01,festivalArrivalRatio:.001};a.effectsCalculated=dojo.clone(a.effects)},action:function(a,b){b=b.resPool.getAmtDependsOnStock([{res:"catnip",amt:-a.effectsCalculated.catnipPerTickCon},
{res:"spice",amt:-a.effectsCalculated.spicePerTickCon}],a.on);a.effects.catnipPerTickCon=a.effectsCalculated.catnipPerTickCon*b;a.effects.spicePerTickCon=a.effectsCalculated.spicePerTickCon*b;a.effects.festivalRatio=a.effectsCalculated.festivalRatio*b;a.effects.festivalArrivalRatio=a.effectsCalculated.festivalArrivalRatio*b;return b},flavor:$I("buildings.brewery.flavor"),unlocks:{zebraUpgrades:["darkBrew"]},unlockScheme:{name:"chocolate",threshold:10}},{name:"amphitheatre",effects:{unhappinessRatio:0,
culturePerTickBase:0,cultureMax:0},stages:[{label:$I("buildings.amphitheatre.label"),description:$I("buildings.amphitheatre.desc"),prices:[{name:"wood",val:200},{name:"minerals",val:1200},{name:"parchment",val:3}],priceRatio:1.15,effects:{unhappinessRatio:-.048,culturePerTickBase:.005,cultureMax:50},stageUnlocked:!0,flavor:$I("buildings.amphitheatre.flavor")},{label:$I("buildings.broadcasttower.label"),description:$I("buildings.broadcasttower.desc"),prices:[{name:"iron",val:1250},{name:"titanium",
val:75}],priceRatio:1.18,effects:{unhappinessRatio:-.75,culturePerTickBase:1,cultureMax:300},stageUnlocked:!1}],action:function(a,b){if(1==a.stage){a=a.stages[1];a.effects.culturePerTickBase=1;a.effects.cultureMax=300;var c=b.resPool.energyProd/b.resPool.energyCons;1<c&&(1.75<c&&(c=1.75),a.effects.culturePerTickBase=Math.floor(1E3*c)/1E3,a.effects.cultureMax=Math.floor(3E5*c)/1E3);c=b.getEffect("broadcastTowerRatio");b=b.space.getBuilding("sattelite").on*c;a.effects.culturePerTickBase*=1+b;a.effects.cultureMax*=
1+b}}},{name:"chapel",label:$I("buildings.chapel.label"),description:$I("buildings.chapel.desc"),prices:[{name:"minerals",val:2E3},{name:"culture",val:250},{name:"parchment",val:250}],priceRatio:1.15,effects:{culturePerTickBase:0,faithPerTickBase:0,cultureMax:0},calculateEffects:function(a,b){b=b.challenges.isActive("atheism")?{culturePerTickBase:.05,cultureMax:200}:{culturePerTickBase:.05,faithPerTickBase:.005,cultureMax:200};a.effects=b}},{name:"temple",label:$I("buildings.temple.label"),description:$I("buildings.temple.desc"),
prices:[{name:"gold",val:50},{name:"slab",val:25},{name:"plate",val:15},{name:"manuscript",val:10}],priceRatio:1.15,effects:{culturePerTickBase:0,faithPerTickBase:0,happiness:0,manpowerMax:0,scienceMax:0,cultureMax:0,faithMax:0},calculateEffects:function(a,b){if(b.challenges.isActive("atheism"))c={culturePerTickBase:.1};else{0<a.val&&b.time.queue.unlockQueueSource("religion");var c={culturePerTickBase:.1,faithPerTickBase:0,happiness:0,manpowerMax:0,scienceMax:0,cultureMax:0,faithMax:100};b.science.get("theology").researched&&
(c.faithPerTickBase=.0015);var d=b.religion.getRU("stainedGlass");d.on&&(c.culturePerTickBase+=.05*d.on);d=b.religion.getRU("scholasticism");d.on&&(c.scienceMax=400+100*d.on);d=b.religion.getRU("sunAltar");d.on&&(c.happiness=.4+.1*d.on,c.faithMax+=50*d.on);d=b.religion.getRU("goldenSpire");d.on&&(c.faithMax*=1+(.4+.1*d.on));d=b.religion.getRU("basilica");d.on&&(c.culturePerTickBase+=.2+.05*(d.on-1),c.cultureMax=75+50*d.on);b=b.religion.getRU("templars");b.on&&(c.manpowerMax=50+25*b.on)}a.effects=
c},flavor:$I("buildings.temple.flavor")},{name:"unicornPasture",label:$I("buildings.unicornPasture.label"),description:$I("buildings.unicornPasture.desc"),unlockRatio:.3,prices:[{name:"unicorns",val:2}],priceRatio:1.75,effects:{catnipDemandRatio:-.0015,unicornsPerTickBase:.001},flavor:$I("buildings.unicornPasture.flavor")},{name:"ziggurat",label:$I("buildings.ziggurat.label"),description:$I("buildings.ziggurat.desc"),unlockRatio:.01,prices:[{name:"scaffold",val:50},{name:"blueprint",val:1},{name:"megalith",
val:50}],priceRatio:1.25,effects:{cultureMaxRatio:.08},calculateEffects:function(a,b){var c={cultureMaxRatio:.08};c.cultureMaxRatio=.08+b.getEffect("cultureMaxRatioBonus");a.effects=c;a.val&&b.time.queue.unlockQueueSource("zigguratUpgrades")}},{name:"chronosphere",label:$I("buildings.chronosphere.label"),description:$I("buildings.chronosphere.desc"),prices:[{name:"unobtainium",val:2500},{name:"science",val:25E4},{name:"timeCrystal",val:1},{name:"blueprint",val:100}],priceRatio:1.25,effects:{resStasisRatio:.015,
temporalFluxProduction:0,energyConsumption:0},upgrades:{voidSpace:["cryochambers"]},calculateEffects:function(a,b){a.effects.energyConsumption=20;a.effects.temporalFluxProduction=b.getEffect("temporalFluxProductionChronosphere")}},{name:"aiCore",label:$I("buildings.aicore.label"),description:$I("buildings.aicore.desc"),unlockRatio:.01,prices:[{name:"antimatter",val:125},{name:"science",val:5E5}],priceRatio:1.15,effects:{gflopsPerTickBase:.02,energyConsumption:2},upgrades:{buildings:["library"],spaceBuilding:["moonBase"]},
unlockScheme:{name:"cyber",threshold:5},updateEffects:function(a,b){a.effects.energyConsumption=(3*a.on+5)/4;var c=.02*(1+b.getEffect("aiCoreProductivness"));a.effects.gflopsPerTickBase=c;a.effects.aiLevel=Math.round(Math.log(Math.max(b.resPool.get("gflops").value,1)))},action:function(a,b){b.resPool.get("gflops").value+=a.effects.gflopsPerTickBase*a.on;a.updateEffects(a,b)},flavor:$I("buildings.aicore.flavor"),canSell:function(a,b){if(1==b.science.getPolicy("transkittenism").researched||15>a.effects.aiLevel)return!0;
b.systemShockMode=!0;b.msg($I("buildings.aicore.attemptsell"));return!1}},{name:"zebraOutpost",label:$I("buildings.zebraOutpost.label"),description:$I("buildings.zebraOutpost.desc"),unlockRatio:.01,prices:[{name:"bloodstone",val:1}],priceRatio:1.35,zebraRequired:5,effects:{hunterRatio:.05,manpowerMax:5,zebraPreparations:0},calculateEffects:function(a,b){b.workshop.getZebraUpgrade("darkRevolution").researched&&(a.effects.zebraPreparations=b.ironWill?1:.1,a.jammed=!1)},action:function(a,b){1>a.val||
a.jammed||(b.upgrade(a.upgrades),a.jammed=!0)},upgrades:{buildings:["zebraWorkshop"]}},{name:"zebraWorkshop",label:$I("buildings.zebraWorkshop.label"),description:$I("buildings.zebraWorkshop.desc"),unlockRatio:.01,prices:[{name:"bloodstone",val:5}],unlocks:{zebraUpgrades:["darkRevolution"]},priceRatio:1.15,zebraRequired:10,effects:{manpowerMax:25,bloodstoneRatio:0},calculateEffects:function(a,b){b.workshop.getZebraUpgrade("bloodstoneInstitute").researched&&(a.effects.bloodstoneRatio=.01*b.getLimitedDR(a.on*
(b.ironWill?1:.1)*(b.karmaZebras+1),b.getEffect("zebraPreparations")+40)/a.on);a.val&&b.time.queue.unlockQueueSource("zebraUpgrades")},upgrades:{buildings:["zebraWorkshop"]}},{name:"zebraForge",label:$I("buildings.zebraForge.label"),description:$I("buildings.zebraForge.desc"),unlockRatio:.01,prices:[{name:"bloodstone",val:50}],unlocks:{crafts:["bloodstone","tMythril"],zebraUpgrades:["whispers"]},priceRatio:1.15,zebraRequired:50,effects:{manpowerMax:50,tMythrilCraftRatio:.01}},{name:"ivoryTemple",
defaultUnlockable:!0,label:$I("buildings.ivoryTemple.label"),description:$I("buildings.ivoryTemple.desc"),unlockRatio:.1,prices:[{name:"tMythril",val:1},{name:"ivory",val:100}],priceRatio:1.15,effects:{ivoryPerTickCon:0,mineralsPerTickProd:0,titaniumPerTickCon:0,alicornPerTickCon:0,tMythrilPerTick:0,manpowerMax:10},lackResConvert:!1,togglable:!0,calculateEffects:function(a,b){b.workshop.getZebraUpgrade("whispers").researched&&0<a.on&&null==a.isAutomationEnabled&&(a.isAutomationEnabled=!0)},action:function(a,
b){a.effects=a.isAutomationEnabled?{ivoryPerTickCon:-200,mineralsPerTickProd:2,titaniumPerTickCon:-2,alicornPerTickCon:-2E-5,tMythrilPerTick:5E-5,manpowerMax:10}:{ivoryPerTickCon:-100,mineralsPerTickProd:1,titaniumPerTickCon:0,alicornPerTickCon:0,tMythrilPerTick:0,manpowerMax:10};b=b.resPool.getAmtDependsOnStock([{res:"ivory",amt:-a.effects.ivoryPerTickCon},{res:"titanium",amt:-a.effects.titaniumPerTickCon},{res:"alicorn",amt:-a.effects.alicornPerTickCon}],a.on);a.effects.ivoryPerTickCon*=b;a.effects.mineralsPerTickProd*=
b;a.effects.titaniumPerTickCon*=b;a.effects.alicornPerTickCon*=b;a.effects.tMythrilPerTick*=b}}],effectsBase:{catnipMax:5E3,woodMax:200,mineralsMax:250,coalMax:60,ironMax:50,titaniumMax:2,goldMax:10,oilMax:1500,uraniumMax:250,unobtainiumMax:150,antimatterMax:100,manpowerMax:100,scienceMax:250,cultureMax:100,faithMax:100,hutFakeBought:0,logHouseFakeBought:0,mansionFakeBought:0},pollutionEffects:{catnipPollutionRatio:0,pollutionHappines:0,solarRevolutionPollution:0,pollutionDissipationRatio:1E-7,pollutionArrivalSlowdown:0},
get:function(a){for(var b=0;b<this.buildingsData.length;b++){var c=this.buildingsData[b];if(c.name==a)return c}console.error("Could not find building data for '"+a+"'")},getBuildingExt:function(a){var b=this.metaCache[a];if(b)return b;for(b=0;b<this.buildingsData.length;b++){var c=this.buildingsData[b];if(c.name==a)return b=new classes.BuildingMeta(c),this.metaCache[a]=b}},getAutoProductionRatio:function(){var a=1*(1+this.game.religion.getSolarRevolutionRatio());var b=this.get("steamworks");b=0<b.on?
1+b.effects.magnetoBoostRatio*this.get("steamworks").on:1;a*=1+this.game.getEffect("magnetoRatio")*b;a*=1+.05*this.game.prestige.getParagonProductionRatio();return a*=1+this.game.getEffect("productionRatio")},getPriceRatio:function(a){a=this.getBuildingExt(a);return this.getPriceRatioWithAccessor(a)},getPriceRatioWithAccessor:function(a){var b=a.get("priceRatio"),c=b-1;a=this.game.getEffect(a.meta.name+"PriceRatio")+this.game.getEffect("priceRatio")+this.game.getEffect("mapPriceReduction");a=this.game.getLimitedDR(a,
c);return b+a},getPrices:function(a,b){a=this.getBuildingExt(a);return this.getPricesWithAccessor(a,b)},getPricesWithAccessor:function(a,b){b=b||0;var c=a.get("prices"),d=this.getPriceRatioWithAccessor(a),e=[],g=1-this.game.getLimitedDR(this.game.getEffect(a.get("name")+"CostReduction"),1);b=this.game.getEffect(a.get("name")+"FakeBought")+b;for(var f=0;f<c.length;f++){var h=1-this.game.getLimitedDR(this.game.getEffect(c[f].name+"CostReduction"),1);e.push({val:c[f].val*Math.pow(d,a.get("val")+b)*g*
h,name:c[f].name})}if(this.game.challenges.isActive("blackSky")&&"calciner"==a.get("name")&&0==a.get("val"))for(f=0;f<e.length;f++)e[f].val*="titanium"==e[f].name?0:11;if(this.game.challenges.isActive("pacifism")&&"steamworks"==a.get("name")&&0==a.get("val"))for(f=0;f<e.length;f++)"blueprint"==e[f].name&&(e[f].val=5*this.game.challenges.getChallenge("pacifism").on+1);this.game.challenges.isActive("postApocalypse")&&"field"==a.get("name")&&5<=this.getPollutionLevel()&&a.get("val")>=95-this.game.time.getVSU("usedCryochambers").val-
this.getPollutionLevel()&&(a=Math.max(a.get("val")+this.game.time.getVSU("usedCryochambers").val-100,0),e.push({val:15*Math.pow(d,a),name:"unobtainium",isTemporary:!0}));return e},calculatePollutionEffects:function(){var a=this.getPollutionLevelBase(),b=this.getPollutionLevel(),c=this.cathPollution;this.game.challenges.isActive("postApocalypse")&&(this.game.bld.pollutionEffects.pollutionDissipationRatio=0,8<b?(this.game.bld.effectsBase.hutFakeBought=b-8,this.game.bld.effectsBase.logHouseFakeBought=
b-8,this.game.bld.effectsBase.mansionFakeBought=b-8):(this.game.bld.effectsBase.hutFakeBought=0,this.game.bld.effectsBase.logHouseFakeBought=0,this.game.bld.effectsBase.mansionFakeBought=0));4<=b?(this.pollutionEffects.catnipPollutionRatio=this.game.getLimitedDR(-.5-.1*Math.log(c),10)/10,this.pollutionEffects.pollutionHappines=1.2*-Math.log(c),this.pollutionEffects.pollutionArrivalSlowdown=1.2*Math.log10(this.game.bld.cathPollution),this.pollutionEffects.solarRevolutionPollution=-Math.min(1E-10*(c-
1E3*a)/9,1)):3==b?(this.pollutionEffects.catnipPollutionRatio=this.game.getLimitedDR(-.5-.1*Math.log(c),10)/10,this.pollutionEffects.pollutionHappines=1.18*-Math.log(c),this.pollutionEffects.pollutionArrivalSlowdown=1.11*Math.log10(this.game.bld.cathPollution),this.pollutionEffects.solarRevolutionPollution=0):2==b?(this.pollutionEffects.catnipPollutionRatio=this.game.getLimitedDR(-.5-.1*Math.log(c),10)/10,this.pollutionEffects.pollutionHappines=1.08*-Math.log(c),this.pollutionEffects.pollutionArrivalSlowdown=
c>=100*a/2?1+1.68E-8*(c-100*a/2):0,this.pollutionEffects.solarRevolutionPollution=0):1==b?(this.pollutionEffects.catnipPollutionRatio=-.2-.05*(c-a)/(10*a),this.pollutionEffects.pollutionHappines=c>=10*a/2?-3.2E-7*(c-10*a/2):0,this.pollutionEffects.pollutionArrivalSlowdown=0,this.pollutionEffects.solarRevolutionPollution=0):0==b&&(this.pollutionEffects.catnipPollutionRatio=c>=a/2?-.2*(c-a/2)/(a/2):0,this.pollutionEffects.pollutionHappines=0,this.pollutionEffects.pollutionArrivalSlowdown=0,this.pollutionEffects.solarRevolutionPollution=
0);-.75>this.pollutionEffects.catnipPollutionRatio&&(this.pollutionEffects.catnipPollutionRatio=-.75)},update:function(){for(var a=!1,b=0;b<this.buildingsData.length;b++){var c=this.buildingsData[b];c.unlocked?this.isUnlockable(c)||(c.unlocked=!1):this.isUnlocked(c)&&(a=c.unlocked=!0);if(c.action&&(0<c.on||"biolab"==c.name||"aiCore"==c.name)){var d=c.action(c,this.game);"undefined"!=typeof d&&(c.lackResConvert=1!=d&&0!=c.on)}}this.calculatePollutionEffects();this.game.bld.effectsBase.manpowerMax=
100;this.game.ironWill&&(this.game.workshop.get("huntingArmor").researched?this.game.bld.effectsBase.manpowerMax=1E3:this.game.workshop.get("bolas").researched?this.game.bld.effectsBase.manpowerMax=400:this.game.workshop.get("compositeBow").researched&&(this.game.bld.effectsBase.manpowerMax=200));a&&this.game.render()},getEffect:function(a){for(var b=0,c=0;c<this.meta.length;c++){var d=this.getMetaEffect(a,this.meta[c]);b+=d}return b},isUnlocked:function(a){if(!this.isUnlockable(a))return!1;var b=
!0;a=(new classes.BuildingMeta(a)).getMeta();var c=a.unlockRatio;if(a.prices.length&&"number"==typeof c)for(var d=0;d<a.prices.length;d++){var e=a.prices[d];if(this.game.resPool.get(e.name).value<e.val*c){b=!1;break}}return b},isUnlockable:function(a){return a.defaultUnlockable||a.unlockable},save:function(a){a.buildings=this.filterMetadata(this.buildingsData,"name unlocked val on stage jammed isAutomationEnabled".split(" "));a.bldData||(a.bldData={});a.bldData.groupBuildings=this.groupBuildings;
a.bldData.twoRows=this.twoRows;a.cathPollution=this.cathPollution},load:function(a){this.groupBuildings=a.bldData?a.bldData.groupBuildings:!1;this.twoRows=a.bldData?a.bldData.twoRows:!1;this.loadMetadata(this.buildingsData,a.buildings);this.cathPollution=a.cathPollution||0;this.calculatePollutionEffects()},resetState:function(){for(var a=0;a<this.buildingsData.length;a++){var b=this.buildingsData[a];b.unlocked=!1;b.unlockable=b.defaultUnlockable||!1;if("object"==typeof b.stages){b.stage=0;for(var c=
1;c<b.stages.length;c++)b.stages[c].stageUnlocked=!1}void 0!=b.jammed&&(b.jammed=!1);this.resetStateStackable(b)}this.cathPollutionPerTick=this.cathPollution=0},getCleanEnergy:function(){var a=this.getBuildingExt("pasture").meta,b=this.getBuildingExt("aqueduct").meta,c=this.getBuildingExt("reactor").meta,d=this.game.space.getBuilding("sattelite");a=1==a.stage&&a.stages[1].effects?a.stages[1].effects.energyProduction*a.on:0;a+=1==b.stage&&b.stages[1].effects?b.stages[1].effects.energyProduction*b.on:
0;a+=c.effects.energyProduction*c.on/2;return a+=d.effects.energyProduction*d.on},getPollutingEnergy:function(){var a=this.getBuildingExt("magneto").meta,b=this.getBuildingExt("steamworks").meta;return a.effects.energyProduction*a.on+b.effects.energyProduction*b.on},getCleanEnergyProdRatio:function(){return this.getCleanEnergy()+this.getPollutingEnergy()?this.getCleanEnergy()/(this.getCleanEnergy()+this.getPollutingEnergy()):0},getPollutionRatio:function(){return 1-this.getCleanEnergyProdRatio()/
2},getPollutionLevelBase:function(){return 1E7},getPollutionLevel:function(a){void 0==a&&(a=this.cathPollution);return 0>=a?0:Math.max(Math.floor(Math.log10(10*a/this.getPollutionLevelBase())),0)},devAddStorage:function(){this.get("warehouse").val+=10;this.get("warehouse").on+=10;this.get("barn").val+=10;this.get("barn").on+=10;this.get("harbor").val+=10;this.get("harbor").on+=10},gatherCatnip:function(){this.game.resPool.get("catnip").value++},refineCatnip:function(){var a=this.game.getResCraftRatio("wood");
this.game.resPool.addResEvent("wood",1+a)},getUndissipatedPollutionPerTick:function(){return this.game.getEffect("cathPollutionPerTickProd")*this.getPollutionRatio()*(1+this.game.getEffect("cathPollutionRatio"))+this.game.getEffect("cathPollutionPerTickCon")},cacheCathPollutionPerTick:function(){this.cathPollutionPerTick=this.getUndissipatedPollutionPerTick()-this.cathPollution*this.pollutionEffects.pollutionDissipationRatio},getEquilibriumPollution:function(){if(this.pollutionEffects.pollutionDissipationRatio)return this.getUndissipatedPollutionPerTick()/
this.pollutionEffects.pollutionDissipationRatio;if(0>this.cathPollutionPerTick)return 0;if(0==this.cathPollutionPerTick)return this.cathPollution;if(0<this.cathPollutionPerTick)return Number.POSITIVE_INFINITY;console.log("No equilibrium found");return-1},setEquilibriumPollution:function(){var a=this.getEquilibriumPollution();-1!=a&&(this.cathPollution=a)},cathPollutionFastForward:function(a,b){if(b||!this.pollutionEffects.pollutionDissipationRatio)this.cathPollution+=this.cathPollutionPerTick*a;else{b=
-this.pollutionEffects.pollutionDissipationRatio;a=Math.exp(b*a);var c=this.getUndissipatedPollutionPerTick();this.cathPollution=Math.max(((this.cathPollution*b+c)*a-c)/b,0)}},fastforward:function(a){function b(k,q,u){for(var n=k.value,v=.98*k.maxValue,r=c.workshop.getCraft(q).prices[0].val,t=0,p=0,w=m;u&&0<w--&&n>=v&&0<(p=Math.floor(Math.min(n,k.maxValue)*h/r));)t+=p,n-=p*r;return{numberOfCrafts:t,craft:function(){0<this.numberOfCrafts&&c.workshop.craft(q,this.numberOfCrafts)}}}var c=this.game;this.cacheCathPollutionPerTick();
this.cathPollutionFastForward(a*c.calendar.ticksPerDay);var d=this.get("steamworks");if(!(1>d.on)&&c.workshop.get("factoryAutomation").researched){null==d.isAutomationEnabled&&(d.isAutomationEnabled=!0);var e=c.resPool.get("wood"),g=c.resPool.get("minerals"),f=c.resPool.get("iron");if(0!=e.maxValue&&0!=g.maxValue){var h=Math.min(.02*(d.on+1),.9),l=this.game.calendar.daysPerSeason*this.game.calendar.seasonsPerYear/(this.game.workshop.get("advancedAutomation").researched?2:1),m=Math.floor(a/l);e=b(e,
"beam",!0);g=b(g,"slab",!0);f=b(f,"plate",c.workshop.get("pneumaticPress").researched);if(0!=e.numberOfCrafts||0!=g.numberOfCrafts||0!=f.numberOfCrafts)d.jammed=!0,d.isAutomationEnabled&&(f.craft(),g.craft(),e.craft(),c.opts.enableRedshiftGflops&&(d=this.get("aiCore"),c.resPool.get("gflops").value+=d.effects.gflopsPerTickBase*d.on*a*c.calendar.ticksPerDay))}}},undo:function(a){var b=a.val,c=this.get(a.metaId);c=(new classes.BuildingMeta(c)).getMeta();"build"==a.action?(a={key:c.name,name:c.label,
description:c.description,building:c.name},a.controller="object"==typeof c.stages?new classes.ui.btn.StagingBldBtnController(this.game):new classes.ui.btn.BuildingBtnModernController(this.game),c=a.controller.fetchModel(a),c.refundPercentage=1,a.controller.sellInternal(c,c.metadata.val-b)):"sell"==a.action?console.warn("Not implemented yet"):"upgrade"==a.action?console.warn("Not implemented yet"):"downgrade"==a.action&&console.warn("Not implemented yet")}});
dojo.declare("classes.game.ui.GatherCatnipButtonController",com.nuclearunicorn.game.ui.ButtonModernController,{buyItem:function(a,b,c){var d=this;clearTimeout(this.game.gatherTimeoutHandler);this.game.gatherTimeoutHandler=setTimeout(function(){d.game.gatherClicks=0},2500);this.game.gatherClicks++;2500<=this.game.gatherClicks&&!this.game.ironWill&&(this.game.gatherClicks=0,this.game.cheatMode=!0);this.game.bld.gatherCatnip();c(!0)}});
dojo.declare("classes.game.ui.RefineCatnipButtonController",com.nuclearunicorn.game.ui.ButtonModernController,{fetchModel:function(a){var b=this.inherited(arguments),c=this,d=this.game.resPool.get("catnip").value;b.x100Link={title:"x100",visible:d>=100*b.prices[0].val,handler:function(e){c.handleX100Click(b)}};return b},handleX100Click:function(a){var b=this.game.resPool.get("catnip").value;a=a.prices[0].val;if(b<100*a)return this.game.msg($I("craft.msg.notEnoughCatnip"));this.game.resPool.addResEvent("catnip",
-100*a);b=this.game.getResCraftRatio("wood");this.game.resPool.addResEvent("wood",100*(1+b))}});dojo.declare("classes.game.ui.RefineCatnipButton",com.nuclearunicorn.game.ui.ButtonModern,{x100Href:null,update:function(){this.inherited(arguments);this.x100Href?dojo.style(this.x100Href.link,"display",this.model.x100Link.visible?"":"none"):this.x100Href=this.addLink(this.model.x100Link)}});
dojo.declare("classes.ui.btn.BuildingBtnModernController",com.nuclearunicorn.game.ui.BuildingStackableBtnController,{getMetadata:function(a){a.metaAccessor=this.game.bld.getBuildingExt(a.options.building);var b=a.metaAccessor.getMeta();a=this.game.bld.get(a.options.building);b.unlockable=a.unlockable;b.unlocked=a.unlocked;b.on=a.on;b.val=a.val||a.on;return b},getName:function(a){var b=a.metadata,c=this.inherited(arguments),d=this.game.village.sim;"hut"==b.name&&d.nextKittenProgress&&10>=d.maxKittens&&
(c+=" ["+(100*d.nextKittenProgress).toFixed()+"%]");b.almostLimited&&(c="* "+c+" *");return c},getPrices:function(a){return this.game.bld.getPricesWithAccessor(a.metaAccessor)},hasSellLink:function(a){return!this.game.opts.hideSell},build:function(a,b){var c=this.inherited(arguments);this.game.stats.getStat("buildingsConstructed").val+=c;this.game.telemetry.logEvent("building",{name:a.options.building,val:c});this.game.registerUndoChange().addEvent("building",{action:"build",metaId:a.options.building,
val:c})},sell:function(a,b){this.inherited(arguments)&&this.game.registerUndoChange().addEvent("building",{action:"sell",metaId:b.metadata.name,val:1})},decrementValue:function(a){this.inherited(arguments);a.metaAccessor.set("val",a.metadata.val);a.metaAccessor.set("on",a.metadata.on)},incrementValue:function(a){this.inherited(arguments);a.metaAccessor.set("val",a.metadata.val);a.metaAccessor.set("on",a.metadata.on)}});
dojo.declare("classes.ui.btn.StagingBldBtnController",classes.ui.btn.BuildingBtnModernController,{stageLinks:null,constructor:function(){},fetchModel:function(a){var b=this.inherited(arguments);b.stageLinks=this.getStageLinks(b);return b},getEffects:function(a){var b=a.metadata.effects;(a=a.metadata.stages[a.metadata.stage])&&a.effects&&(b=a.effects);return b},getTotalEffects:function(a){return this.getMetadataRaw(a).totalEffectsCached},getStageLinks:function(a){for(var b=this,c=[],d=a.metadata.stages,
e=a.metadata.stage||0,g=function(){b.downgrade(a)},f=function(){b.upgrade(a)},h=1;h<d.length;h++)h<=e?this.game.opts.hideDowngrade||c.push({title:"v",handler:g,enabled:!0}):d[h].stageUnlocked&&c.push({title:"^",handler:f,enabled:!0});return c},downgrade:function(a){if(this.game.opts.noConfirm)this.deltagrade(this,a,-1);else{var b=this;this.game.ui.confirm("",$I("buildings.downgrade.confirmation.msg"),function(){b.deltagrade(b,a,-1)})}},upgrade:function(a){if(this.game.opts.noConfirm)this.deltagrade(this,
a,1);else{var b=this;this.game.ui.confirm("",$I("buildings.upgrade.confirmation.msg"),function(){b.deltagrade(b,a,1)})}},deltagrade:function(a,b,c){b=a.getMetadataRaw(b);b.stage+=c;b.stage||(b.stage=Math.max(0,c));b.val=0;b.on=0;b.calculateEffects&&b.calculateEffects(b,a.game);a.game.upgrade(b.upgrades);a.game.render()},getMetadataRaw:function(a){return this.game.bld.get(a.metadata.name)}});
dojo.declare("classes.ui.btn.StagingBldBtn",com.nuclearunicorn.game.ui.BuildingStackableBtn,{stageLinks:null,constructor:function(){this.stageLinks=[]},renderLinks:function(){this.inherited(arguments);for(var a=0;a<this.model.stageLinks.length;a++)this.stageLinks.push(this.addLink(this.model.stageLinks[a]))}});
dojo.declare("com.nuclearunicorn.game.ui.tab.BuildingsModern",com.nuclearunicorn.game.ui.tab,{bldGroups:null,activeGroup:null,constructor:function(a){this.bldGroups=[]},render:function(a){this.bldGroups=[];a=dojo.create("div",{className:"bldTopContainer"},a);var b=dojo.clone(this.game.bld.buildingGroups,!0);this.game.ironWill&&this.game.libraryTab.visible&&b.unshift({name:"iw",title:"IW",buildings:[]});b.unshift({name:"togglable",title:$I("ui.filter.togglable"),buildings:[]});b.unshift({name:"allEnabled",
title:$I("ui.filter.enabled"),buildings:[]});b.unshift({name:"available",title:$I("ui.filter.available"),buildings:[]});b.unshift({name:"all",title:$I("ui.filter.all"),buildings:[]});this.activeGroup||(this.activeGroup=b[0].name);for(var c=0;c<b.length;c++){for(var d=b[c].name==this.activeGroup,e=!1,g=0;g<b[c].buildings.length;g++)if(this.game.bld.get(b[c].buildings[g]).unlocked){e=!0;break}b[c].buildings.length||(e=!0);g=null;0!=c&&(g=dojo.create("span",{innerHTML:" &#183; ",style:{display:e?"":
"none"}},a));d=dojo.create("a",{innerHTML:b[c].title,href:"#",style:{display:e?"":"none",whiteSpace:"nowrap"},className:d?"activeTab":""},a);this.bldGroups.push({group:b[c],visible:e,tab:d,separator:g});dojo.connect(d,"onclick",this,dojo.partial(function(f){this.activeGroup=f;this.game.render()},b[c].name))}this.groupContainer=a=dojo.create("div",{className:"bldGroupContainer"},a);this.renderActiveGroup(a);this.update()},renderActiveGroup:function(a){dojo.empty(a);this.children=[];this.twoRows="all"==
this.activeGroup||"iw"==this.activeGroup;this.initRenderer(a);for(var b=0;b<this.bldGroups.length;b++)if(this.bldGroups[b].group.name==this.activeGroup||"all"==this.activeGroup||"available"==this.activeGroup||"allEnabled"==this.activeGroup||"togglable"==this.activeGroup||"iw"==this.activeGroup){0==b&&this.addCoreBtns(a);for(var c=this.bldGroups[b].group,d=0;d<c.buildings.length;d++){var e=this.game.bld.get(c.buildings[d]);e=(new classes.BuildingMeta(e)).getMeta();e="object"==typeof e.stages?new classes.ui.btn.StagingBldBtn({name:e.label,
description:e.description,building:e.name,twoRow:this.twoRows,controller:new classes.ui.btn.StagingBldBtnController(this.game)},this.game):new com.nuclearunicorn.game.ui.BuildingStackableBtn({name:e.label,description:e.description,building:e.name,twoRow:this.twoRows,controller:new classes.ui.btn.BuildingBtnModernController(this.game)},this.game);var g=e.controller.fetchModel(e.opts);if("available"!=this.activeGroup||!g.resourceIsLimited)if("allEnabled"!=this.activeGroup||g.enabled)if("togglable"!=
this.activeGroup||g.togglable)if("iw"!=this.activeGroup||"population"!=c.name)e.update(),g.visible&&this.addChild(e)}}for(b=0;b<this.children.length;b++)c=this.twoRows?this.getElementContainer(b):a,this.children[b].render(c)},addCoreBtns:function(a){a=new com.nuclearunicorn.game.ui.ButtonModern({name:$I("buildings.gatherCatnip.label"),controller:new classes.game.ui.GatherCatnipButtonController(this.game),description:$I("buildings.gatherCatnip.desc"),twoRow:this.twoRows},this.game);this.addChild(a);
a=a.game.workshop.get("advancedRefinement").researched;var b=this;a=new classes.game.ui.RefineCatnipButton({name:$I("buildings.refineCatnip.label"),controller:new classes.game.ui.RefineCatnipButtonController(this.game),handler:function(c){b.game.bld.refineCatnip()},description:$I("buildings.refineCatnip.desc"),prices:[{name:"catnip",val:a?50:100}],twoRow:this.twoRows},this.game);this.addChild(a)},update:function(){this.inherited(arguments)}});
